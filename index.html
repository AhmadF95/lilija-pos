<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙŠÙ„ÙŠØ¬Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± (v1.1.0)</title>
  <style>
    /* Dark theme (default) */
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444}
    
    /* Light theme */
    :root[data-theme='light']{
      --bg:#f6f7fb;--panel:#ffffff;--muted:#e5e7eb;--text:#0b1023;--accent:var(--accent-color, #0ea5e9);
      --ok:#16a34a;--warn:#ca8a04;--danger:#dc2626;
    }
    
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--muted));color:var(--text)}
    header{position:sticky;top:0;background:var(--bg)cc;backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--muted)}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    h2{margin:16px 0 8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 12px;border:1px solid var(--muted);border-radius:10px;background:var(--panel);cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent)22}
    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:14px;margin-top:14px}
    label{display:block;margin:8px 0 4px}
    input,select{width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--muted);background:var(--bg);color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .g6{grid-column:span 6}.g4{grid-column:span 4}.g3{grid-column:span 3}.g8{grid-column:span 8}.g12{grid-column:span 12}
    @media(max-width:900px){.g6,.g4,.g3,.g8{grid-column:span 12}}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--muted);background:var(--panel);color:var(--text);cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent));color:var(--panel);border:none}
    .btn-danger{background:var(--danger);border:1px solid var(--danger);color:white}
    .btn-muted{background:var(--panel);border:1px solid var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px dashed var(--muted);padding:10px;text-align:right}
    tr:hover{background:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{border:1px solid var(--muted);background:var(--panel);border-radius:14px;padding:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:12px;border:1px solid var(--muted)}
    .tag.warn{border-color:var(--warn);color:var(--warn)}
    .tag.danger{border-color:var(--danger);color:var(--danger)}
    .tag.ok{border-color:var(--ok);color:var(--ok)}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-inline-start:auto}
    .hint{font-size:12px;opacity:.75}

    /* General Settings specific styles */
    .color-swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .color-swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent}
    .color-swatch:hover,.color-swatch.selected{border-color:var(--text)}
    .shop-logo-preview{max-height:40px;margin-top:8px;border-radius:6px}
    .shop-logo-controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    #shopLogoImg{height:20px;border-radius:4px;margin-inline-end:8px}

    /* Auth overlay */
    .overlay{position:fixed;inset:0;background:var(--bg)f0;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:9999}
    .card{width:min(94vw,420px);background:var(--panel);border:1px solid var(--muted);border-radius:14px;padding:18px}
    .card h3{margin:0 0 8px 0}
    .is-hidden{display:none !important;visibility:hidden !important;opacity:0 !important}
  </style>
</head>
<body>
  <header>
    <div class="wrap flex">
      <h1>
        <img id="shopLogoImg" style="display:none" alt="Shop Logo" />
        <svg id="logoLilija" viewBox="0 0 200 200" width="20" height="20" aria-hidden="true" style="vertical-align:-3px;margin-inline-end:6px"><circle cx="100" cy="100" r="88" fill="none" stroke="#e6eef9" stroke-width="12"/><path d="M60 60 v50 c0 25 20 35 40 35 h35" fill="none" stroke="#e6eef9" stroke-width="12" stroke-linecap="round"/><rect x="86" y="132" width="14" height="14" rx="3" fill="#e6eef9"/><rect x="112" y="132" width="14" height="14" rx="3" fill="#e6eef9"/></svg>
        <span id="shopNameSpan">Ù„ÙŠÙ„ÙŠØ¬Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± (v1.1.0)</span> 
        <small id="bootChecks" class="hint" style="font-weight:normal;font-size:12px;opacity:.8" data-i18n="modulesLoaded">ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ù…Ù‘Ù„Ø©: Ø³Ø¬Ù„/Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</small>
      </h1>
      <div class="right flex">
        <span id="whoami" class="hint"></span>
        <button id="btnLogout" class="btn-muted" type="button" hidden data-i18n="btnLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <button id="btnBackup" class="btn-muted" type="button" data-i18n="btnBackup">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <input type="file" id="restoreFile" style="display:none" accept="application/json" />
        <button id="btnRestore" class="btn-muted" type="button" data-i18n="btnRestore">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
        <button id="btnReset" class="btn-danger" type="button" data-i18n="btnReset">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </div>
  </header>
  <!-- Auth Overlay -->
  <div id="authOverlay" class="overlay is-hidden" aria-hidden="true">
    <div class="card" id="authCard">
      <h3 id="authTitle" data-i18n="authTitleLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div id="authBody"></div>
    </div>
  </div>

  <main class="wrap" id="appRoot" hidden>
    <div class="tabs" id="tabs"></div>

    <!-- Ù…Ù†ØªØ¬Ø§Øª -->
    <section class="panel" data-tab="products">
      <h2 data-i18n="productsTitle">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div class="grid">
        <div class="g4">
          <label data-i18n="productNameLabel">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="pName" data-i18n-placeholder="productNamePlaceholder" placeholder="Ù…Ø«Ù„: ØªÙ…Ø± Ø®Ù„Ø§Øµ 500Øº" />
          <label data-i18n="skuLabel">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ / SKU</label><input id="pSku" data-i18n-placeholder="skuPlaceholder" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          <label data-i18n="categoryLabel">Ø§Ù„ÙØ¦Ø©</label><input id="pCat" data-i18n-placeholder="categoryPlaceholder" placeholder="Ù…Ø«Ù„: ØªÙ…ÙˆØ±" />
          <label data-i18n="priceLabel">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (AED)</label><input id="pPrice" type="number" step="0.01" data-i18n-placeholder="pricePlaceholder" placeholder="Ù…Ø«Ø§Ù„: 15.00" />
          <button class="btn-primary" id="addProduct" type="button" data-i18n="btnAddProduct">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
          <div class="hint" data-i18n="productsHint">ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
        </div>
        <div class="g8">
          <div class="flex"><div class="hint" data-i18n="productsTableTitle">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div><div class="right"><button id="exportProducts" type="button" class="btn-muted" data-export="1" data-table="productsTable" data-filename="products.csv" data-i18n="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="productsTable">
            <thead><tr><th data-i18n="thProduct">Ø§Ù„Ù…Ù†ØªØ¬</th><th data-i18n="thSKU">SKU</th><th data-i18n="thCategory">Ø§Ù„ÙØ¦Ø©</th><th data-i18n="thPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th data-i18n="thStock">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù…Ø´ØªØ±ÙŠØ§Øª -->
    <section class="panel" data-tab="purchases" hidden>
      <h2 data-i18n="purchasesTitle">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙˆØ§Ø±Ø¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†)</h2>
      <div class="grid">
        <div class="g4">
          <label data-i18n="selectProduct">Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="buyProduct"></select>
          <label data-i18n="quantityLabel">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="buyQty" type="number" step="1" min="1" />
          <label data-i18n="costLabel">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© (AED)</label><input id="buyCost" type="number" step="0.01" />
          <label data-i18n="dateLabel">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="buyDate" type="date" />
          <button class="btn-primary" id="addPurchase" type="button" data-i18n="btnAddPurchase">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
        </div>
        <div class="g8">
          <div class="flex"><div class="hint" data-i18n="purchasesTableTitle">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div><div class="right"><button id="exportPurchases" type="button" class="btn-muted" data-export="1" data-table="purchasesTable" data-filename="purchases.csv" data-i18n="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="purchasesTable">
            <thead><tr><th data-i18n="thDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th data-i18n="thProduct">Ø§Ù„Ù…Ù†ØªØ¬</th><th data-i18n="thQuantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th data-i18n="thUnitCost">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th data-i18n="thTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th data-i18n="thSupplier">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th><th data-i18n="thSupplierPhone">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th><th data-i18n="thPO">PO#</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <section class="panel" data-tab="sales" hidden>
      <h2 data-i18n="salesTitle">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù)</h2>
      <div class="grid">
        <div class="g4">
          <label data-i18n="selectProductSell">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="sellProduct"></select>
          <label data-i18n="sellQuantityLabel">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="sellQty" type="number" step="1" min="1" value="1" />
          <label data-i18n="sellPriceLabel">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label><input id="sellPrice" type="number" step="0.01" />
          <div class="grid">
            <div class="g6">
              <label data-i18n="discountTypeLabel">Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬</label>
              <select id="lineDiscType">
                <option value="none">Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…</option>
                <option value="amount">Ø®ØµÙ… Ù…Ø¨Ù„Øº</option>
                <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø© %</option>
              </select>
            </div>
            <div class="g6">
              <label data-i18n="discountValueLabel">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label>
              <input id="lineDiscVal" type="number" step="0.01" value="0" />
            </div>
          </div>
          <label data-i18n="deliveryFeeLabel">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="deliveryFee" type="number" step="0.01" value="0" />
          <label data-i18n="customerNameLabel">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="customerName" type="text" data-i18n-placeholder="customerNamePlaceholder" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <label data-i18n="customerPhoneLabel">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="customerPhone" type="tel" data-i18n-placeholder="customerPhonePlaceholder" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
          <button class="btn-primary" id="addLine" type="button" data-i18n="btnAddLine">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨</button>
          <label style="margin-top:12px" data-i18n="orderDateLabel">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label><input id="orderDate" type="date" />
          <button class="btn-primary" id="saveOrder" type="button" style="margin-top:8px" data-i18n="btnSaveOrder">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
        <div class="g8">
          <div class="flex"><h3 style="margin:0" data-i18n="cartTitle">Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3><div class="right"><button id="exportCart" type="button" class="btn-muted" data-export="1" data-table="cartTable" data-filename="cart.csv" data-i18n="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="cartTable">
            <thead><tr><th data-i18n="thProduct">Ø§Ù„Ù…Ù†ØªØ¬</th><th data-i18n="thQuantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th data-i18n="thPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th data-i18n="thDiscount">Ø®ØµÙ…</th><th data-i18n="thTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th colspan="4" style="text-align:left" data-i18n="orderTotalLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</th><th id="orderTotalCell">0.00</th><th></th></tr></tfoot>
          </table>

          <div class="flex" style="margin-top:18px"><h3 style="margin:0" data-i18n="previousOrdersTitle">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3><div class="right">
            <button id="exportOrders" type="button" class="btn-muted" data-export="1" data-table="ordersTable" data-filename="orders.csv" data-i18n="btnExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button>
          </div></div>
          <table id="ordersTable">
            <thead><tr><th data-i18n="thDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th data-i18n="thItems">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th><th data-i18n="thOrderTotal">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</th><th data-i18n="thCustomerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th data-i18n="thCustomerPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th data-i18n="thOptions">Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
    <section class="panel" data-tab="dashboard" hidden>
      <h2 data-i18n="dashboardTitle">Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</h2>
      
      <!-- ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
      <div class="grid" style="margin-bottom: 16px;">
        <div class="g6">
          <label data-i18n="reportPeriodLabel">ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
          <div class="flex" style="gap: 8px;">
            <button type="button" class="tab" id="periodToday" data-period="today" data-i18n="btnToday">Ø§Ù„ÙŠÙˆÙ…</button>
            <button type="button" class="tab" id="periodWeek" data-period="week" data-i18n="btnWeek">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
            <button type="button" class="tab" id="periodMonth" data-period="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
            <button type="button" class="tab" id="periodCustom" data-period="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</button>
          </div>
        </div>
        <div class="g6" id="customDateRange" hidden>
          <div class="flex" style="gap: 8px;">
            <div>
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="customStartDate" />
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="customEndDate" />
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div class="kpis" id="dashboardKpis"></div>

      <!-- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div class="grid" style="margin: 16px 0;">
        <div class="g6">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <select id="chartDataset">
            <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="purchases">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
            <option value="profit">Ø§Ù„Ø±Ø¨Ø­</option>
          </select>
        </div>
        <div class="g6">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</label>
          <select id="chartType">
            <option value="line">Ø®Ø·ÙŠ</option>
            <option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option>
            <option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option>
          </select>
        </div>
      </div>

      <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
      <div style="background: #0b1224; border: 1px solid #1f2a44; border-radius: 14px; padding: 14px; margin: 16px 0;">
        <canvas id="dashboardChart" width="800" height="400" style="width: 100%; height: 300px; max-width: 800px;"></canvas>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
      <div class="flex" style="margin-top: 18px;">
        <h3 style="margin: 0">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
        <div class="right">
          <button id="exportDashboardSummary" type="button" class="btn-muted" data-export="1" data-table="dashboardSummaryTable" data-filename="dashboard-summary.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button>
        </div>
      </div>
      <table id="dashboardSummaryTable">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
            <th>Ø§Ù„Ø±Ø¨Ø­</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ØªÙ‚Ø§Ø±ÙŠØ± -->
    <section class="panel" data-tab="reports" hidden>
      <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
      <div class="kpis" id="kpis"></div>
      <div class="flex"><h3 style="margin:0">Ø£Ø¯Ù†Ù‰ Ù…Ø®Ø²ÙˆÙ†</h3><div class="right"><button id="exportLowStock" type="button" class="btn-muted" data-export="1" data-table="lowStockTable" data-filename="low-stock.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
      <table id="lowStockTable">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="flex" style="margin-top:18px"><h3 style="margin:0">Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ù‹Ø§</h3><div class="right"><button id="exportTopProducts" type="button" class="btn-muted" data-export="1" data-table="topProductsTable" data-filename="top-products.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
      <table id="topProductsTable">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <section class="panel" data-tab="settings" hidden>
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="grid">
        <div class="g6">
          <label>Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù„ÙƒÙ„ Ù…Ù†ØªØ¬)</label>
          <input id="lowStockThreshold" type="number" min="0" step="1" />
          <button class="btn-primary" id="saveSettings" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <div class="hint">ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ "Ù…Ù†Ø®ÙØ¶" Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚Ù„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯.</div>
        </div>
        <div class="g6">
          <h3 style="margin-top:0">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><input id="curPass" type="password" />
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input id="newPass" type="password" />
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input id="newPass2" type="password" />
          <button class="btn-primary" id="btnChangePass" type="button">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
          <div class="hint">ØªÙØ®Ø²Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…ÙØ´ÙÙ‘Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ.</div>
        </div>
      </div>
    
      <!-- LILIJA:BEGIN USERS_ADMIN -->
<div id="usersAdminSection">
        <hr style="border-color:var(--muted);margin:18px 0" />
        <h3 data-i18n="usersTitle">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
        <div id="usersAdminWrap"></div>
      </div>
<!-- LILIJA:END USERS_ADMIN -->
</section>

    <!-- General Settings -->
    <section class="panel" data-tab="general" hidden>
      <h2 id="generalSettingsTitle">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <div class="grid">
        <div class="g6">
          <label id="languageLabel">ğŸŒ Ø§Ù„Ù„ØºØ©</label>
          <select id="uiLanguage">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
          
          <label id="themeLabel">ğŸ¨ Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
          <select id="uiTheme">
            <option value="dark">Ù„ÙŠÙ„ÙŠ (Ø¯Ø§ÙƒÙ†)</option>
            <option value="light">Ù†Ù‡Ø§Ø±ÙŠ (ÙØ§ØªØ­)</option>
          </select>
          
          <label id="accentLabel">ğŸ¯ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ²</label>
          <input type="color" id="uiAccent" value="#22d3ee" style="width:60px;height:40px;padding:2px;border-radius:8px" />
          <div class="color-swatches">
            <div class="color-swatch" style="background:#22d3ee" data-color="#22d3ee" data-i18n-title="colorCyan" title="Ø³Ù…Ø§ÙˆÙŠ"></div>
            <div class="color-swatch" style="background:#39ff14" data-color="#39ff14" data-i18n-title="colorNeonGreen" title="Ø£Ø®Ø¶Ø± Ù†ÙŠÙˆÙ†"></div>
            <div class="color-swatch" style="background:#ff00ff" data-color="#ff00ff" data-i18n-title="colorNeonPurple" title="Ø¨Ù†ÙØ³Ø¬ÙŠ Ù†ÙŠÙˆÙ†"></div>
            <div class="color-swatch" style="background:#00ffff" data-color="#00ffff" data-i18n-title="colorNeonBlue" title="Ø£Ø²Ø±Ù‚ Ù†ÙŠÙˆÙ†"></div>
            <div class="color-swatch" style="background:#ff5f1f" data-color="#ff5f1f" data-i18n-title="colorNeonOrange" title="Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù†ÙŠÙˆÙ†"></div>
            <div class="color-swatch" style="background:#8a2be2" data-color="#8a2be2" data-i18n-title="colorPurple" title="Ø¨Ù†ÙØ³Ø¬ÙŠ"></div>
          </div>
          <div class="hint" id="accentHint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø£Ùˆ Ø§Ø®ØªØ± Ù„ÙˆÙ† Ù…Ø®ØµØµ</div>
        </div>
        
        <div class="g6">
          <label id="shopNameLabel">ğŸª Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
          <input type="text" id="shopName" data-i18n-placeholder="shopNamePlaceholder" placeholder="Ø§Ø³Ù… Ù…ØªØ¬Ø±Ùƒ" />
          <div class="hint" id="shopNameHint">Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©</div>
          
          <label id="shopLogoLabel">ğŸ–¼ï¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±</label>
          <input type="file" id="shopLogoFile" accept="image/*" />
          <div class="shop-logo-controls">
            <button type="button" id="removeLogoBtn" class="btn-muted" style="display:none" id="removeLogoHint">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±</button>
          </div>
          <img id="shopLogoPreview" class="shop-logo-preview" style="display:none" data-i18n-alt="logoPreviewAlt" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±" />
          <div class="hint" id="shopLogoHint">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ø´Ø¹Ø§Ø± Ù…ØªØ¬Ø±Ùƒ (PNG, JPG)</div>
        </div>
      </div>
    </section>
<!-- LILIJA:BEGIN AUDIT_LOG -->
<section class="panel" data-tab="audit" hidden>
  <h2 data-i18n="auditTitle">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
  <div class="hint" data-i18n="auditHint">ÙŠØ³Ø¬Ù‘Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª/Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙˆÙ‚Øª.</div>
  <div class="flex" style="gap:8px;margin:8px 0">
    <input id="auditSearch" data-i18n-placeholder="auditSearchPlaceholder" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." />
    <button id="btnAuditExport" type="button" data-i18n="btnAuditExport">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
    <button id="btnAuditClear" class="btn-danger" type="button" data-i18n="btnAuditClear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
  </div>
  <div class="table-wrap">
    <table id="auditTable">
      <thead><tr><th data-i18n="thTime">Ø§Ù„ÙˆÙ‚Øª</th><th data-i18n="thUser">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th data-i18n="thModule">Ø§Ù„ÙˆØ­Ø¯Ø©</th><th data-i18n="thAction">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th data-i18n="thRefId">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</th><th data-i18n="thDetails">Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th data-i18n="thQuantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- LILIJA:END AUDIT_LOG -->

  

  </main>

  <script>
  
  // ====== Users Admin (inside Settings) ======
  function renderUsersAdmin(){
    ensureUserSchema();
    const section = document.getElementById('usersAdminSection');
    const wrap = document.getElementById('usersAdminWrap');
    if(!section || !wrap) return;
    const me = currentUser(); const isAdmin = me && (me.type==='admin' || me.isRoot===true);
    section.style.display = isAdmin ? '' : 'none';
    if(!isAdmin){ wrap.innerHTML=''; return; }

    const users = loadUsers();
    const isRoot = me && me.isRoot === true;
    const canCreate = isRoot && users.length < 5;

    let htmlUI = '<div class="hint">'+(isRoot?'Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.':'Ø¹Ø±Ø¶ ÙÙ‚Ø·')+'</div>';
    if(isRoot){
      htmlUI += '<div class="flex" style="gap:8px;margin:8px 0"><button id="btnCreateUser" class="btn-primary" type="button">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button><span class="hint">(' + users.length + '/5)</span></div>';
    }
    htmlUI += '<div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</th><th>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</th><th>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</th><th></th></tr></thead><tbody>';

    function permCells(u, mod){
      const p=(u.perms&&u.perms[mod])||{};
      function cb(act, lbl){
        const checked = (u.type==='admin') ? 'checked disabled' : (p[act]?'checked':'');
        return '<label class="hint" style="display:inline-flex;gap:4px;align-items:center;margin:0 6px"><input data-uid="'+u.username+'" data-mod="'+mod+'" data-act="'+act+'" type="checkbox" '+checked+' /><span>'+lbl+'</span></label>';
      }
      return u.isRoot ? 'â€”' : cb('view','Ø±Ø¤ÙŠØ©') + cb('edit','ØªØ¹Ø¯ÙŠÙ„') + cb('delete','Ø­Ø°Ù');
    }

    users.forEach(u=>{
      htmlUI += '<tr><td>'+u.username+'</td><td>'+(u.isRoot? '<span class="hint">Ø£Ø¯Ù…Ù† Ø±Ø¦ÙŠØ³ÙŠ</span>' : `<select data-role="${u.username}"><option value="user" ${u.type==='user'?'selected':''}>User</option><option value="admin" ${u.type==='admin'?'selected':''}>Admin</option></select>` )+'</td>'
      + '<td>'+permCells(u,'products')+'</td>'
      + '<td>'+permCells(u,'sales')+'</td>'
      + '<td>'+permCells(u,'purchases')+'</td>'
      + '<td>'+permCells(u,'users')+'</td>'
      + '<td>'+permCells(u,'settings')+'</td>'
      + '<td>'+permCells(u,'audit')+'</td>'
      + '<td>'+(u.isRoot ? '' : `<button class="btn-danger" data-remove="${u.username}" type="button">Ø­Ø°Ù</button>` )+'</td></tr>';
    });

    htmlUI += '</tbody></table></div>';
    wrap.innerHTML = htmlUI;

    wrap.onchange = (e)=>{
      const uname = e.target.getAttribute('data-role');
      if(uname){
        const list = loadUsers(); const u = list.find(x=>x.username===uname); if(!u) return;
        if(u.isRoot) { e.target.value = 'admin'; return; }
        const nextType = e.target.value;
        const adminCount = list.filter(x => x.type==='admin' || x.isRoot===true).length;
        if(u.type==='admin' && nextType!=='admin' && adminCount<=1){
          alert(getTranslation(getUISettings().language, 'alertMustKeepOneAdmin')); e.target.value = 'admin'; return;
        }
        u.type = nextType; saveUsers(list); return;
      }
      const uid = e.target.getAttribute('data-uid');
      if(uid){
        const mod = e.target.getAttribute('data-mod');
        const act = e.target.getAttribute('data-act');
        const list = loadUsers(); const u = list.find(x=>x.username===uid); if(!u) return;
        if(u.isRoot) return;
        u.perms = u.perms || {}; u.perms[mod] = u.perms[mod] || {view:false,edit:false,delete:false};
        u.perms[mod][act] = e.target.checked; saveUsers(list); return;
      }
    };
    wrap.onclick = (e)=>{
      const rm = e.target.getAttribute('data-remove');
      if(rm){
        if(rm===currentUser) return alert(getTranslation(getUISettings().language, 'alertCannotDeleteSelf'));
        const list = loadUsers(); const u = list.find(x=>x.username===rm); if(u?.isRoot) return;
        const next = list.filter(x=>x.username!==rm);
        const adminCount = next.filter(x => x.type==='admin' || x.isRoot===true).length;
        if(adminCount===0) return alert(getTranslation(getUISettings().language, 'alertMustKeepOneAdmin'));
        saveUsers(next); renderUsersAdmin(); return;
      }
    };

    const btn = document.getElementById('btnCreateUser');
    if(btn){
      btn.disabled = !canCreate;
      btn.onclick = async ()=>{
        if(!canCreate) return;
        const uname = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ'); if(!uname) return;
        const pass1 = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ'); if(!pass1) return;
        const list = loadUsers();
        if(list.length>=5) return alert(getTranslation(getUISettings().language, 'alertMaxUsers'));
        if(list.find(x=>x.username.toLowerCase()===uname.toLowerCase())) return alert(getTranslation(getUISettings().language, 'alertUsernameExists'));
        const salt = genSalt(); const hash = await sha256(pass1 + salt);
        const defaultPermsUser = Object.fromEntries(LilijaAuth.MODULES.map(m=>[m,{view:true,edit:false,delete:false}]));
        list.push({ username:uname, salt, hash, type:'user', perms: defaultPermsUser });
        saveUsers(list); renderUsersAdmin();
      };
    }
  }

  // ====== (replaced) ======
  //(function(){
  //  const body = document.body;
  //  if(!body.__lilijaProductsBound){
   //   body.__lilijaProductsBound = true;
    //  body.addEventListener('click', (ev)=>{
      //  const addBtn = ev.target.closest('#addProduct');
        //if(addBtn){
        //  try{
         //   const pName = document.getElementById('pName');
          //  const pSku  = document.getElementById('pSku');
         //   const pCat  = document.getElementById('pCat');
          //  const pPrice= document.getElementById('pPrice');
           // const name = (pName?.value||'').trim();
          //  if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
           // const _id = uid();
            //db.products.push({ id:_id, name, sku:(pSku?.value||'').trim(), cat:(pCat?.value||'').trim(), price:Number(pPrice?.value)||0 });
            //try{ recordAudit('add','products', _id, name, 0); }catch(e){}
           // saveDB(db);
           // if(pName) pName.value=''; if(pSku) pSku.value=''; if(pCat) pCat.value=''; if(pPrice) pPrice.value='';
           // refreshAll();
          //}catch(e){ console.warn('addProduct (delegate) failed', e); }
         // return;
       // }
       // const delBtn = ev.target.closest('#productsTable [data-del]');
        //if(delBtn){
         // try{
          //  const id = delBtn.getAttribute('data-del');
           // if(!id) return;
           // if(!softConfirm(delBtn)) return;
           // const px = db.products.find(x=>x.id===id);
            //try{ recordAudit('delete','products', id, px?px.name:''); }catch(e){}
            //db.products = db.products.filter(x=>x.id!==id);
           // saveDB(db); refreshAll();
          //}catch(e){ console.warn('delete product (delegate) failed', e); }
          //return;
       // }
     // }, true);
    //}
  //})();

  // ====== Robust click bindings (products add/delete) v2 ======
// Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ (PO)
function ensureCounters(){
  db.counters = db.counters || {};
  if (typeof db.counters.nextPo !== 'number') db.counters.nextPo = 1001; // Ø§Ø¨Ø¯Ø£ Ù…Ù† 1001 Ù…Ø«Ù„Ø§Ù‹
}
function nextPo(){
  ensureCounters();
  const n = db.counters.nextPo;
  db.counters.nextPo++;
  if (typeof saveDB === 'function') saveDB(db);
  return n;
}
// ====== Auth & DB Keys ======
  const USERS_KEY = 'miniStoreUsers_v1';
  const SESSION_KEY = 'miniStoreSession_v1';
  let currentUser = null;
  let dbKeyBase = 'miniStoreDB_v3_orders';
  let dbKey = dbKeyBase;

  // ====== Crypto helpers ======
  const enc = new TextEncoder();
  async function sha256(text){ const buf = await crypto.subtle.digest('SHA-256', enc.encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function genSalt(){ return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2); }

  function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) || []; }catch{ return []; } }
  function saveUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
  function setSession(username){ sessionStorage.setItem(SESSION_KEY, JSON.stringify({username})); }
  function getSession(){ try{ return JSON.parse(sessionStorage.getItem(SESSION_KEY)); }catch{ return null; } }
  function clearSession(){ sessionStorage.removeItem(SESSION_KEY); }

  // ====== Data Layer ======
  const nowISO = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(36).slice(2,9);
  const deepClone = (o)=> JSON.parse(JSON.stringify(o));
  const defaults = { products: [], purchases: [], sales: [], settings: { lowStockThreshold: 5, ui: { language: 'ar', theme: 'dark', accent: '#22d3ee', shopName: '', shopLogo: '' } }, audit: [] };
  function loadDB(){ try{ return JSON.parse(localStorage.getItem(dbKey)) || deepClone(defaults);}catch{ return deepClone(defaults); } }
  function saveDB(db){ localStorage.setItem(dbKey, JSON.stringify(db)); }
  
  let db = null;
  
  // ====== Light App namespace to reduce global pollution ======
  window.App = {
    db: null,
    setDB: function(newDb) { 
      this.db = newDb; 
      window.db = newDb; // Keep legacy global for compatibility
    },
    getDB: function() { return this.db || window.db; },
    getCurrentUser: () => window.getCurrentUser ? getCurrentUser() : null,
    utils: window.LilijaUtils,
    auth: window.LilijaAuth, 
    data: window.LilijaData
  };
  
  window.db = db;

  // ====== i18n Support (comprehensive) ======
  const i18n = {
    ar: {
      // Document title
      appTitle: 'Ù„ÙŠÙ„ÙŠØ¬Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± (v1.1.0)',
      
      // Header
      modulesLoaded: 'ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ù…Ù‘Ù„Ø©: Ø³Ø¬Ù„/Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†',
      currentUser: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:',
      btnLogout: 'ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
      btnBackup: 'â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
      btnRestore: 'â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
      btnReset: 'â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·',
      
      // Auth
      authTitleLogin: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
      authTitleRegister: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ±',
      usernameLabel: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      passwordLabel: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
      confirmPasswordLabel: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
      btnLogin: 'Ø¯Ø®ÙˆÙ„',
      btnRegister: 'Ø¥Ù†Ø´Ø§Ø¡',
      usernamePlaceholder: 'Ù…Ø«Ø§Ù„: admin',
      authHint: 'ØªÙØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ´ÙÙ‘Ø±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.',
      loginHint: 'Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¨Ø¹Ø¯ØŒ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.',
      
      // Tab labels
      products: 'ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
      purchases: 'â¬…ï¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 
      sales: 'â¡ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨Ø§Øª)',
      dashboard: 'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶',
      reports: 'ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
      settings: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
      audit: 'ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª',
      general: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
      
      // Products section
      productsTitle: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
      productNameLabel: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬',
      productNamePlaceholder: 'Ù…Ø«Ù„: ØªÙ…Ø± Ø®Ù„Ø§Øµ 500Øº',
      skuLabel: 'Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ / SKU',
      skuPlaceholder: 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ',
      categoryLabel: 'Ø§Ù„ÙØ¦Ø©',
      categoryPlaceholder: 'Ù…Ø«Ù„: ØªÙ…ÙˆØ±',
      priceLabel: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (AED)',
      pricePlaceholder: 'Ù…Ø«Ø§Ù„: 15.00',
      btnAddProduct: 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬',
      productsHint: 'ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.',
      productsTableTitle: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
      btnExport: 'â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)',
      thProduct: 'Ø§Ù„Ù…Ù†ØªØ¬',
      thSKU: 'SKU',
      thCategory: 'Ø§Ù„ÙØ¦Ø©',
      thPrice: 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹',
      thStock: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
      
      // Purchases section
      purchasesTitle: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙˆØ§Ø±Ø¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†)',
      selectProduct: 'Ø§Ù„Ù…Ù†ØªØ¬',
      quantityLabel: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
      costLabel: 'Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© (AED)',
      dateLabel: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
      btnAddPurchase: 'â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡',
      purchasesTableTitle: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
      thDate: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
      thQuantity: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
      thUnitCost: 'ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©',
      thTotal: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
      thSupplier: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯',
      thSupplierPhone: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯',
      thPO: 'PO#',
      
      // Sales section
      salesTitle: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù)',
      selectProductSell: 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬',
      sellQuantityLabel: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
      sellPriceLabel: 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)',
      discountTypeLabel: 'Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬',
      discountNone: 'Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…',
      discountAmount: 'Ø®ØµÙ… Ù…Ø¨Ù„Øº',
      discountPercent: 'Ø®ØµÙ… Ù†Ø³Ø¨Ø© %',
      discountValueLabel: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…',
      deliveryFeeLabel: 'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
      customerNameLabel: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
      customerNamePlaceholder: 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
      customerPhoneLabel: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
      customerPhonePlaceholder: 'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
      btnAddLine: 'â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨',
      orderDateLabel: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨',
      btnSaveOrder: 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨',
      cartTitle: 'Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨',
      thDiscount: 'Ø®ØµÙ…',
      orderTotalLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨',
      previousOrdersTitle: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©',
      thItems: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù',
      thOrderTotal: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨',
      thCustomerName: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
      thCustomerPhone: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
      thOptions: 'Ø®ÙŠØ§Ø±Ø§Øª',
      
      // Dashboard section
      dashboardTitle: 'Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶',
      reportPeriodLabel: 'ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
      btnToday: 'Ø§Ù„ÙŠÙˆÙ…',
      btnWeek: 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
      btnMonth: 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
      btnCustom: 'ÙØªØ±Ø© Ù…Ø®ØµØµØ©',
      fromDateLabel: 'Ù…Ù† ØªØ§Ø±ÙŠØ®',
      toDateLabel: 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®',
      
      // General settings
      generalSettingsTitle: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©',
      languageLabel: 'ğŸŒ Ø§Ù„Ù„ØºØ©',
      themeLabel: 'ğŸ¨ Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶',
      accentLabel: 'ğŸ¯ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ²',
      shopNameLabel: 'ğŸª Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±',
      shopLogoLabel: 'ğŸ–¼ï¸ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±',
      accentHint: 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø£Ùˆ Ø§Ø®ØªØ± Ù„ÙˆÙ† Ù…Ø®ØµØµ',
      shopNameHint: 'Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©',
      shopNamePlaceholder: 'Ø§Ø³Ù… Ù…ØªØ¬Ø±Ùƒ',
      shopLogoHint: 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ø´Ø¹Ø§Ø± Ù…ØªØ¬Ø±Ùƒ (PNG, JPG)',
      removeLogoHint: 'ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±',
      logoPreviewAlt: 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±',
      themeDark: 'Ù„ÙŠÙ„ÙŠ (Ø¯Ø§ÙƒÙ†)',
      themeLight: 'Ù†Ù‡Ø§Ø±ÙŠ (ÙØ§ØªØ­)',
      
      // Color swatches titles
      colorCyan: 'Ø³Ù…Ø§ÙˆÙŠ',
      colorNeonGreen: 'Ø£Ø®Ø¶Ø± Ù†ÙŠÙˆÙ†',
      colorNeonPurple: 'Ø¨Ù†ÙØ³Ø¬ÙŠ Ù†ÙŠÙˆÙ†',
      colorNeonBlue: 'Ø£Ø²Ø±Ù‚ Ù†ÙŠÙˆÙ†',
      colorNeonOrange: 'Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù†ÙŠÙˆÙ†',
      colorPurple: 'Ø¨Ù†ÙØ³Ø¬ÙŠ',
      
      // Audit Log section
      auditTitle: 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª',
      auditHint: 'ÙŠØ³Ø¬Ù‘Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª/Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙˆÙ‚Øª.',
      auditSearchPlaceholder: 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...',
      btnAuditExport: 'â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV',
      btnAuditClear: 'ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„',
      thTime: 'Ø§Ù„ÙˆÙ‚Øª',
      thUser: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      thModule: 'Ø§Ù„ÙˆØ­Ø¯Ø©',
      thAction: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡',
      thRefId: 'Ø§Ù„Ù…Ø¹Ø±Ù‘Ù',
      thDetails: 'Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªÙØ§ØµÙŠÙ„',
      
      // Users Admin section
      usersTitle: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª',
      usersHintRoot: 'Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.',
      usersHintView: 'Ø¹Ø±Ø¶ ÙÙ‚Ø·',
      btnCreateUser: 'â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
      thUsername: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      thType: 'Ø§Ù„Ù†ÙˆØ¹',
      thProducts: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
      thSales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
      thPurchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
      thUsers: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†',
      thSettings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
      thAudit: 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª',
      btnDelete: 'Ø­Ø°Ù',
      rootAdminLabel: 'Ø£Ø¯Ù…Ù† Ø±Ø¦ÙŠØ³ÙŠ',
      
      // Additional common action buttons
      btnEdit: 'ØªØ¹Ø¯ÙŠÙ„',
      btnView: 'Ø¹Ø±Ø¶',
      btnInvoice: 'ÙØ§ØªÙˆØ±Ø©',
      
      // Purchases section - missing keys
      supplierNamePlaceholder: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
      supplierPhonePlaceholder: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
      purchaseDraftTitle: 'Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
      nextPOLabel: 'PO Ø§Ù„Ù‚Ø§Ø¯Ù…:',
      btnSaveInvoice: 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
      btnPrintDraft: 'ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',
      btnClearDraft: 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©',
      confirmClearDraft: 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©ØŸ',
      printDraftTitle: 'Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',
      supplierLabel: 'Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯',
      phoneLabel: 'Ù‡Ø§ØªÙ',
      
      // User management messages
      usersHintRoot: 'Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.',
      usersHintView: 'Ø¹Ø±Ø¶ ÙÙ‚Ø·',
      btnCreateUser: 'â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
      permView: 'Ø±Ø¤ÙŠØ©',
      permEdit: 'ØªØ¹Ø¯ÙŠÙ„',
      permDelete: 'Ø­Ø°Ù',
      promptUsername: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ',
      promptPassword: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ',
      alertMaxUsers: 'Ø¨Ù„ØºØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
      alertUsernameExists: 'Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯',
      alertCannotDeleteSelf: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ',
      alertMustKeepOneAdmin: 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„',
      
      // Delete confirmation
      deleteConfirmTitle: 'Ø­Ø°Ù Â«{name}Â» Ù…Ù† {module}ØŸ',
      deleteReasonPrompt: 'Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):',
      alertNoDeletePermission: 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­Ø°Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©',
      
      // Generic strings for fallbacks
      genericItem: 'Ø§Ù„Ø¹Ù†ØµØ±',
      tableNotFound: 'Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
      accountNotFound: 'Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
      wrongCurrentPassword: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
      passwordChanged: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
      passwordMismatch: 'ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯',
      
      // Success messages
      orderSaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨',
      settingsSaved: 'ØªÙ… Ø§Ù„Ø­ÙØ¸',
      backupRestored: 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
      systemReset: 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·',
      accountCreated: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.',
      
      // Error messages
      invalidFile: 'Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­',
      invalidCredentials: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
      enterUsernamePassword: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±',
      passwordConfirmMismatch: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚',
      
      // Product validation errors
      enterProductName: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬',
      productNameExists: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§',
      skuExists: 'Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯/â€SKU Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§',
      usernameAlreadyExists: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§',
      
      // Audit log section - all labels
      auditSearchPlaceholder: 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...',
      btnAuditExport: 'â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV',
      btnAuditClear: 'ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„',
      auditClearConfirm: 'Ù…Ø³Ø­ ÙƒØ§Ù…Ù„ Ø§Ù„Ø³Ø¬Ù„ØŸ',
      auditNoPermission: 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­',
      thTime: 'Ø§Ù„ÙˆÙ‚Øª',
      thUser: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      thModule: 'Ø§Ù„ÙˆØ­Ø¯Ø©',
      thAction: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡',
      thRefId: 'Ø§Ù„Ù…Ø¹Ø±Ù‘Ù',
      thDetails: 'Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªÙØ§ØµÙŠÙ„',
      thQty: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
      
      // Additional table headers for purchases draft
      thUnitCostDraft: 'ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©',
      
      // Users table headers
      thUsername: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      thType: 'Ø§Ù„Ù†ÙˆØ¹'
    },
    en: {
      // Document title
      appTitle: 'Lilija â€” Store Manager (v1.1.0)',
      
      // Header
      modulesLoaded: 'Modules loaded: log/users',
      currentUser: 'User:',
      btnLogout: 'ğŸšª Logout',
      btnBackup: 'â¬‡ï¸ Download Backup',
      btnRestore: 'â¬†ï¸ Restore',
      btnReset: 'â™»ï¸ Reset',
      
      // Auth
      authTitleLogin: 'Login',
      authTitleRegister: 'Create Admin Account',
      usernameLabel: 'Username',
      passwordLabel: 'Password',
      confirmPasswordLabel: 'Confirm Password',
      btnLogin: 'Login',
      btnRegister: 'Create',
      usernamePlaceholder: 'e.g: admin',
      authHint: 'Account data is stored encrypted locally on this browser only.',
      loginHint: 'If you haven\'t created an account yet, the create account screen will appear automatically.',
      
      // Tab labels  
      products: 'ğŸ“¦ Products',
      purchases: 'â¬…ï¸ Purchases',
      sales: 'â¡ï¸ Sales (Orders)', 
      dashboard: 'ğŸ“Š Dashboard',
      reports: 'ğŸ“ˆ Reports',
      settings: 'âš™ï¸ Settings',
      audit: 'ğŸ“ Audit Log',
      general: 'âš™ï¸ General Settings',
      
      // Products section
      productsTitle: 'Products',
      productNameLabel: 'Product Name',
      productNamePlaceholder: 'e.g: Premium Dates 500g',
      skuLabel: 'Barcode / SKU',
      skuPlaceholder: 'Optional',
      categoryLabel: 'Category',
      categoryPlaceholder: 'e.g: Dates',
      priceLabel: 'Default Selling Price (AED)',
      pricePlaceholder: 'e.g: 15.00',
      btnAddProduct: 'â• Add Product',
      productsHint: 'The products list is used automatically in all other screens.',
      productsTableTitle: 'Products Table',
      btnExport: 'â¬‡ï¸ Export (Excel)',
      thProduct: 'Product',
      thSKU: 'SKU',
      thCategory: 'Category',
      thPrice: 'Selling Price',
      thStock: 'Stock',
      
      // Purchases section
      purchasesTitle: 'Purchases (Inventory Inbound)',
      selectProduct: 'Product',
      quantityLabel: 'Quantity',
      costLabel: 'Cost Price per Unit (AED)',
      dateLabel: 'Date',
      btnAddPurchase: 'â• Add Purchase',
      purchasesTableTitle: 'Purchases Table',
      thDate: 'Date',
      thQuantity: 'Quantity',
      thUnitCost: 'Unit Cost',
      thTotal: 'Total',
      thSupplier: 'Supplier Name',
      thSupplierPhone: 'Supplier Phone',
      thPO: 'PO#',
      
      // Sales section
      salesTitle: 'Sales (Multi-Item Order)',
      selectProductSell: 'Select Product',
      sellQuantityLabel: 'Quantity',
      sellPriceLabel: 'Unit Price (from products page, editable)',
      discountTypeLabel: 'Product Discount Type',
      discountNone: 'No Discount',
      discountAmount: 'Amount Discount',
      discountPercent: 'Percentage Discount %',
      discountValueLabel: 'Discount Value',
      deliveryFeeLabel: 'Delivery Fee (Optional)',
      customerNameLabel: 'Customer Name (Optional)',
      customerNamePlaceholder: 'Enter customer name',
      customerPhoneLabel: 'Phone Number (Optional)',
      customerPhonePlaceholder: 'Enter phone number',
      btnAddLine: 'â• Add to Order',
      orderDateLabel: 'Order Date',
      btnSaveOrder: 'ğŸ’¾ Save Order',
      cartTitle: 'Order Cart',
      thDiscount: 'Discount',
      orderTotalLabel: 'Order Total',
      previousOrdersTitle: 'Previous Orders',
      thItems: 'Items Count',
      thOrderTotal: 'Order Total',
      thCustomerName: 'Customer Name',
      thCustomerPhone: 'Phone Number',
      thOptions: 'Options',
      
      // Dashboard section
      dashboardTitle: 'Dashboard',
      reportPeriodLabel: 'Report Period',
      btnToday: 'Today',
      btnWeek: 'This Week',
      btnMonth: 'This Month',
      btnCustom: 'Custom Period',
      fromDateLabel: 'From Date',
      toDateLabel: 'To Date',
      
      // General settings
      generalSettingsTitle: 'âš™ï¸ General Settings',
      languageLabel: 'ğŸŒ Language',
      themeLabel: 'ğŸ¨ Theme Mode',
      accentLabel: 'ğŸ¯ Accent Color',
      shopNameLabel: 'ğŸª Shop Name', 
      shopLogoLabel: 'ğŸ–¼ï¸ Shop Logo',
      accentHint: 'Click on a color swatch or choose custom',
      shopNameHint: 'Will appear in the header',
      shopNamePlaceholder: 'Your shop name',
      shopLogoHint: 'Choose an image for your shop logo (PNG, JPG)',
      removeLogoHint: 'ğŸ—‘ï¸ Remove Logo',
      logoPreviewAlt: 'Logo Preview',
      themeDark: 'Dark (Night)',
      themeLight: 'Light (Day)',
      
      // Color swatches titles
      colorCyan: 'Cyan',
      colorNeonGreen: 'Neon Green',
      colorNeonPurple: 'Neon Purple',
      colorNeonBlue: 'Neon Blue',
      colorNeonOrange: 'Neon Orange',
      colorPurple: 'Purple',
      
      // Audit Log section
      auditTitle: 'Audit Log',
      auditHint: 'Records all additions/modifications/deletions with username and time.',
      auditSearchPlaceholder: 'Search by name/type/user...',
      btnAuditExport: 'â¬‡ï¸ Export CSV',
      btnAuditClear: 'ğŸ—‘ï¸ Clear Log',
      thTime: 'Time',
      thUser: 'User',
      thModule: 'Module',
      thAction: 'Action',
      thRefId: 'Ref ID',
      thDetails: 'Name/Details',
      
      // Users Admin section
      usersTitle: 'Users and Permissions',
      usersHintRoot: 'Only the root admin can create users.',
      usersHintView: 'View only',
      btnCreateUser: 'â• Create New User',
      thUsername: 'Username',
      thType: 'Type',
      thProducts: 'Products',
      thSales: 'Sales',
      thPurchases: 'Purchases',
      thUsers: 'Users',
      thSettings: 'Settings',
      thAudit: 'Audit Log',
      btnDelete: 'Delete',
      rootAdminLabel: 'Root Admin',
      
      // Additional common action buttons
      btnEdit: 'Edit',
      btnView: 'View',
      btnInvoice: 'Invoice',
      
      // Purchases section - missing keys  
      supplierNamePlaceholder: 'Supplier name (optional)',
      supplierPhonePlaceholder: 'Supplier phone (optional)',
      purchaseDraftTitle: 'Purchase Invoice Draft',
      nextPOLabel: 'Next PO:',
      btnSaveInvoice: 'ğŸ’¾ Save Invoice',
      btnPrintDraft: 'ğŸ–¨ï¸ Print Draft',
      btnClearDraft: 'Clear Draft',
      confirmClearDraft: 'Clear draft?',
      printDraftTitle: 'Purchase Invoice Draft',
      supplierLabel: 'Supplier',
      phoneLabel: 'Phone',
      
      // User management messages
      usersHintRoot: 'Only the root admin can create users.',
      usersHintView: 'View only',
      btnCreateUser: 'â• Create New User',
      permView: 'View',
      permEdit: 'Edit',
      permDelete: 'Delete',
      promptUsername: 'Username?',
      promptPassword: 'Password?',
      alertMaxUsers: 'Maximum 5 users reached',
      alertUsernameExists: 'Username already exists',
      alertCannotDeleteSelf: 'Cannot delete current account',
      alertMustKeepOneAdmin: 'Must keep at least one admin account',
      
      // Delete confirmation
      deleteConfirmTitle: 'Delete Â«{name}Â» from {module}?',
      deleteReasonPrompt: 'Reason for deletion (optional):',
      alertNoDeletePermission: 'No permission to delete from this module',
      
      // Generic strings for fallbacks
      genericItem: 'Item',
      tableNotFound: 'Table not found',
      accountNotFound: 'Account not found',
      wrongCurrentPassword: 'Current password is incorrect',
      passwordChanged: 'Password changed',
      passwordMismatch: 'Please verify new password and confirmation match',
      
      // Success messages
      orderSaved: 'Order saved',
      settingsSaved: 'Settings saved',
      backupRestored: 'Backup restored successfully',
      systemReset: 'System reset completed',
      accountCreated: 'Account created. You can now log in.',
      
      // Error messages
      invalidFile: 'Invalid file',
      invalidCredentials: 'Invalid credentials',
      enterUsernamePassword: 'Enter username and password',
      passwordConfirmMismatch: 'Password confirmation does not match',
      
      // Product validation errors
      enterProductName: 'Enter product name',
      productNameExists: 'Product name already exists',
      skuExists: 'Barcode/SKU already in use',
      usernameAlreadyExists: 'Username already exists',
      
      // Audit log section - all labels
      auditSearchPlaceholder: 'Search by name/type/user...',
      btnAuditExport: 'â¬‡ï¸ Export CSV',
      btnAuditClear: 'ğŸ—‘ï¸ Clear Log',
      auditClearConfirm: 'Clear entire log?',
      auditNoPermission: 'Not allowed',
      thTime: 'Time',
      thUser: 'User',
      thModule: 'Module',
      thAction: 'Action',
      thRefId: 'Ref ID',
      thDetails: 'Name/Details',
      thQty: 'Quantity',
      
      // Additional table headers for purchases draft  
      thUnitCostDraft: 'Unit Cost',
      
      // Users table headers
      thUsername: 'Username', 
      thType: 'Type'
    }
  };

  // ====== i18n Helper Functions ======
  
  // Get translation for a key, with fallback to English
  function getTranslation(lang, key) {
    if (i18n[lang] && i18n[lang][key]) {
      return i18n[lang][key];
    }
    // Fallback to English
    if (i18n.en && i18n.en[key]) {
      return i18n.en[key];
    }
    // If key doesn't exist in either language, return the key itself
    return key;
  }

  // Update a single element with translation
  function translateElement(element, lang) {
    if (!element) return;
    
    // Handle data-i18n attribute (for textContent)
    const i18nKey = element.getAttribute('data-i18n');
    if (i18nKey) {
      element.textContent = getTranslation(lang, i18nKey);
    }
    
    // Handle data-i18n-placeholder attribute
    const placeholderKey = element.getAttribute('data-i18n-placeholder');
    if (placeholderKey) {
      element.placeholder = getTranslation(lang, placeholderKey);
    }
    
    // Handle data-i18n-title attribute
    const titleKey = element.getAttribute('data-i18n-title');
    if (titleKey) {
      element.title = getTranslation(lang, titleKey);
    }
    
    // Handle data-i18n-aria attribute
    const ariaKey = element.getAttribute('data-i18n-aria');
    if (ariaKey) {
      element.setAttribute('aria-label', getTranslation(lang, ariaKey));
    }
    
    // Handle data-i18n-alt attribute for images
    const altKey = element.getAttribute('data-i18n-alt');
    if (altKey) {
      element.alt = getTranslation(lang, altKey);
    }
  }

  // Apply translations to entire page
  function applyTranslations(lang) {
    // Save language preference to localStorage
    localStorage.setItem('pos.lang', lang);
    
    // Update document title
    document.title = getTranslation(lang, 'appTitle');
    
    // Update document language and direction
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    
    // Find and translate all elements with data-i18n* attributes
    const elementsWithI18n = document.querySelectorAll('[data-i18n], [data-i18n-placeholder], [data-i18n-title], [data-i18n-aria], [data-i18n-alt]');
    elementsWithI18n.forEach(element => translateElement(element, lang));
    
    // Handle special cases: dropdown options that can't use data-i18n reliably
    const themeOptions = document.querySelectorAll('#uiTheme option');
    if (themeOptions.length >= 2) {
      themeOptions[0].textContent = getTranslation(lang, 'themeDark'); // Dark theme
      themeOptions[1].textContent = getTranslation(lang, 'themeLight'); // Light theme
    }
    
    const discountOptions = document.querySelectorAll('#lineDiscType option');
    if (discountOptions.length >= 3) {
      discountOptions[0].textContent = getTranslation(lang, 'discountNone');
      discountOptions[1].textContent = getTranslation(lang, 'discountAmount');
      discountOptions[2].textContent = getTranslation(lang, 'discountPercent');
    }
    
    // Update the existing tab rendering and general settings
    renderTabs();
    updateGeneralSettingsLabels();
    
    // Refresh dynamic content that uses translations
    try { 
      refreshAll(); // Refresh all dynamic content like tables
      if (typeof renderUsersAdmin === 'function') renderUsersAdmin(); // Refresh users admin
      if (typeof renderAudit === 'function') renderAudit(); // Refresh audit log
    } catch (e) {
      console.warn('Error refreshing dynamic content:', e);
    }
  }

  // Initialize language from localStorage or default to Arabic
  function initializeLanguage() {
    const savedLang = localStorage.getItem('pos.lang') || 'ar';
    applyTranslations(savedLang);
    
    // Set the language dropdown if it exists
    const langDropdown = document.getElementById('uiLanguage');
    if (langDropdown) {
      langDropdown.value = savedLang;
    }
  }

  // ====== Helpers ======
  // Note: productMap, sum, calcStats moved to modules/utils.js and modules/data.js

  // ====== UI Tabs ======
  const tabsCfg = [
    {id:'products', label:'ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª'},
    {id:'purchases', label:'â¬…ï¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª'},
    {id:'sales', label:'â¡ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨Ø§Øª)'},
    {id:'dashboard', label:'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶'},
    {id:'reports', label:'ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
    {id:'general', label:'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©'},
    {id:'settings', label:'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'},
    {id:'audit', label:'ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª'},
  ];
  
  // Note: Auth & permissions moved to modules/auth.js

  // ====== UI Settings Functions ======
  function getUISettings() {
    if (!db || !db.settings) return { language: 'ar', theme: 'dark', accent: '#22d3ee', shopName: '', shopLogo: '' };
    if (!db.settings.ui) {
      db.settings.ui = { language: 'ar', theme: 'dark', accent: '#22d3ee', shopName: '', shopLogo: '' };
    }
    return db.settings.ui;
  }

  function saveUISettings(settings) {
    if (!db.settings.ui) db.settings.ui = {};
    Object.assign(db.settings.ui, settings);
    saveDB(db);
  }

  function applyUISettings() {
    const ui = getUISettings();
    
    // Apply language and direction
    document.documentElement.lang = ui.language;
    document.documentElement.dir = ui.language === 'ar' ? 'rtl' : 'ltr';
    
    // Apply theme
    document.documentElement.setAttribute('data-theme', ui.theme);
    
    // Apply accent color
    document.documentElement.style.setProperty('--accent-color', ui.accent);
    document.documentElement.style.setProperty('--accent', ui.accent);
    
    // Apply comprehensive translations
    applyTranslations(ui.language);
    
    // Update header logo and name
    const shopLogoImg = document.getElementById('shopLogoImg');
    const logoLilija = document.getElementById('logoLilija');
    const shopNameSpan = document.getElementById('shopNameSpan');
    
    if (ui.shopLogo) {
      shopLogoImg.src = ui.shopLogo;
      shopLogoImg.style.display = 'inline';
      logoLilija.style.display = 'none';
    } else {
      shopLogoImg.style.display = 'none';
      logoLilija.style.display = 'inline';
    }
    
    if (ui.shopName) {
      shopNameSpan.textContent = ui.shopName;
    } else {
      shopNameSpan.textContent = getTranslation(ui.language, 'appTitle');
    }
    
    // Update user status text
    const whoami = document.getElementById('whoami');
    const currentUserName = window.currentUser ? window.currentUser.username || 'unknown' : '';
    if (whoami && currentUserName) {
      whoami.textContent = getTranslation(ui.language, 'currentUser') + ' ' + currentUserName;
    }
    
    // Update tab labels
    renderTabs();
    
    // Update general settings labels
    updateGeneralSettingsLabels();
  }

  function renderTabs() {
    const ui = getUISettings();
    const lang = ui.language;
    const tabsEl = document.getElementById('tabs');
    if (!tabsEl) return;
    
    // Clear existing tabs
    tabsEl.innerHTML = '';
    
    // Recreate tabs with current language labels
    tabsCfg.forEach(t => {
      const b = document.createElement('button');
      b.className = 'tab';
      b.textContent = i18n[lang][t.id] || t.label;
      b.dataset.tab = t.id;
      tabsEl.appendChild(b);
    });
  }

  function updateGeneralSettingsLabels() {
    const ui = getUISettings();
    const lang = ui.language;
    
    // Update general settings labels
    const elements = {
      generalSettingsTitle: document.getElementById('generalSettingsTitle'),
      languageLabel: document.getElementById('languageLabel'),
      themeLabel: document.getElementById('themeLabel'),
      accentLabel: document.getElementById('accentLabel'),
      shopNameLabel: document.getElementById('shopNameLabel'),
      shopLogoLabel: document.getElementById('shopLogoLabel'),
      accentHint: document.getElementById('accentHint'),
      shopNameHint: document.getElementById('shopNameHint'),
      shopLogoHint: document.getElementById('shopLogoHint'),
      removeLogoHint: document.getElementById('removeLogoBtn')
    };
    
    Object.keys(elements).forEach(key => {
      if (elements[key] && i18n[lang][key]) {
        if (key === 'removeLogoHint') {
          elements[key].textContent = i18n[lang][key];
        } else {
          elements[key].textContent = i18n[lang][key];
        }
      }
    });
  }

  function renderGeneralSettings() {
    const ui = getUISettings();
    
    // Set current values
    document.getElementById('uiLanguage').value = ui.language;
    document.getElementById('uiTheme').value = ui.theme;
    document.getElementById('uiAccent').value = ui.accent;
    document.getElementById('shopName').value = ui.shopName || '';
    
    // Update logo preview
    const preview = document.getElementById('shopLogoPreview');
    const removeBtn = document.getElementById('removeLogoBtn');
    
    if (ui.shopLogo) {
      preview.src = ui.shopLogo;
      preview.style.display = 'block';
      removeBtn.style.display = 'inline-block';
    } else {
      preview.style.display = 'none';
      removeBtn.style.display = 'none';
    }
    
    // Update accent color swatch selection
    updateAccentSwatches();
    
    // Update labels
    updateGeneralSettingsLabels();
  }

  function updateAccentSwatches() {
    const ui = getUISettings();
    const swatches = document.querySelectorAll('.color-swatch');
    swatches.forEach(swatch => {
      swatch.classList.toggle('selected', swatch.dataset.color === ui.accent);
    });
  }

  const tabsEl = document.getElementById('tabs');
  // Initial tab rendering (will be updated by applyUISettings)
  tabsCfg.forEach(t=>{ const b = document.createElement('button'); b.className='tab'; b.textContent=t.label; b.dataset.tab=t.id; if(tabsEl) tabsEl.appendChild(b); });
  
  function activateTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    document.querySelectorAll('section.panel').forEach(s=>{ 
      s.hidden = s.dataset.tab!==id; 
      if(id==='settings' && typeof renderUsersAdmin==='function') renderUsersAdmin(); 
      if(id==='general') renderGeneralSettings();
      if(id==='audit' && typeof renderAudit==='function') renderAudit();
      if(id==='dashboard' && typeof renderDashboard==='function') renderDashboard();
    });
    localStorage.setItem(dbKey+':tab', id);
    refreshAll();
  }
  tabsEl.addEventListener('click', (e)=>{ if(e.target.classList.contains('tab')) activateTab(e.target.dataset.tab); });
  function getLastTab(){ return localStorage.getItem(dbKey+':tab') || 'products'; }

  // ====== Products ======
  
  // Product duplicate validation helpers
  function isDuplicateProductName(name, exceptId) {
    const n = (name || '').trim().toLowerCase();
    if (!n) return false;
    try {
      return Array.isArray(window.db?.products) && window.db.products.some(p =>
        (p?.name || '').trim().toLowerCase() === n && p.id !== exceptId
      );
    } catch (e) { return false; }
  }

  function isDuplicateSKU(sku, exceptId) {
    const s = (sku || '').trim().toLowerCase();
    if (!s) return false; // empty SKU allowed
    try {
      return Array.isArray(window.db?.products) && window.db.products.some(p =>
        (p?.sku || '').trim().toLowerCase() === s && p.id !== exceptId
      );
    } catch (e) { return false; }
  }

  // Guard against double-definition
  if (typeof window.isDuplicateProductName !== 'function') window.isDuplicateProductName = isDuplicateProductName;
  if (typeof window.isDuplicateSKU !== 'function') window.isDuplicateSKU = isDuplicateSKU;

  const pName = document.getElementById('pName');
  const pSku = document.getElementById('pSku');
  const pCat = document.getElementById('pCat');
  const pPrice = document.getElementById('pPrice');
  document.getElementById('addProduct').onclick = () => {
  // Ù‚Ø±Ø§Ø¡Ø§Øª ÙˆØ­Ø³Ø§Ø¨Ø§Øª Ø£ÙˆÙ„ÙŠØ©
  const nameRaw = pName.value || '';
  const skuRaw  = pSku.value || '';
  const catRaw  = pCat.value || '';
  const priceRaw = Number(pPrice.value) || 0;

  const name = nameRaw.trim();
  const sku  = skuRaw.trim();
  const cat  = catRaw.trim();

  if (!name) { alert(getTranslation(getUISettings().language, 'enterProductName')); pName.focus(); return; }

  // Check for duplicates using shared utilities
  if (isDuplicateProductName(name)) {
    alert(getTranslation(getUISettings().language, 'productNameExists'));
    pName.focus();
    return;
  }

  if (isDuplicateSKU(sku)) {
    alert(getTranslation(getUISettings().language, 'skuExists'));
    pSku.focus();
    return;
  }

  // Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const _id = uid();
  db.products.push({ id:_id, name, sku, cat, price: priceRaw });
  try { recordAudit && recordAudit('add','products', _id, name, 0); } catch(_) {}
  saveDB(db);

  // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
  pName.value = pSku.value = pCat.value = '';
  pPrice.value = '';

  refreshAll();
};

 function renderProducts() {
  const tbody = document.querySelector('#productsTable tbody');
  if (!tbody) return;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
  tbody.innerHTML = '';
  const stats = calcStats();
  const mapStat = new Map(stats.map(s => [s.id, s]));

  for (const p of db.products) {
    const s = mapStat.get(p.id) || { stock: 0 };
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.sku || ''}</td>
      <td>${p.cat || ''}</td>
      <td>${(p.price || 0).toFixed(2)}</td>
      <td>${s.stock || 0}</td>
      <td class="flex">
        <button data-edit="${p.id}" type="button">${getTranslation(getUISettings().language, 'btnEdit')}</button>
        <button data-del="${p.id}" class="btn-danger" type="button">${getTranslation(getUISettings().language, 'btnDelete')}</button>
      </td>`;
    tbody.appendChild(tr);
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± (ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)
  tbody.onclick = async (e) => {
    const btnEdit = e.target.closest('button[data-edit]');
    const btnDel  = e.target.closest('button[data-del]');
    if (!btnEdit && !btnDel) return;

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    if (btnEdit) {
      const id = btnEdit.dataset.edit;
      const p = db.products.find(x => x.id === id);
      if (!p) return;

      const name  = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', p.name);    if (name  === null) return;
      const sku   = prompt('SKU',        p.sku || ''); if (sku   === null) return;
      const cat   = prompt('Ø§Ù„ÙØ¦Ø©',      p.cat || ''); if (cat   === null) return;
      const price = parseFloat(prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹', p.price || 0));
      if (Number.isNaN(price)) return;

      // Check for duplicates using shared utilities (excluding current product)
      if (isDuplicateProductName(name, p.id)) {
        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
        return;
      }

      if (isDuplicateSKU(sku, p.id)) {
        alert('Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯/â€SKU Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§');
        return;
      }

Object.assign(p, { name, sku, cat, price });
try { recordAudit && recordAudit('edit','products', p.id, `name=${name},sku=${sku},price=${price}`); } catch(_){}
saveDB(db); 
refreshAll();
      return;
    }

    // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯)
    if (btnDel) {
      const idDel = btnDel.dataset.del;
      const px = db.products.find(x => x.id === idDel);
      const res = await confirmDeleteUniversal('products', idDel, px ? px.name : '');
      if (!res.ok) return;

      db.products = db.products.filter(x => x.id !== idDel);
      saveDB(db);
      refreshAll();
      return;
    }
  };
}


  // ====== Purchases ======
  const buyProduct = document.getElementById('buyProduct');
  const buyQty = document.getElementById('buyQty');
  const buyCost = document.getElementById('buyCost');
  const buyDate = document.getElementById('buyDate'); if(buyDate) buyDate.value = nowISO();
//  document.getElementById('addPurchase').onclick = ()=>{
//    const pid = buyProduct.value; if(!pid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
//    const qty = Number(buyQty.value); const cost = Number(buyCost.value);
//    if(!(qty>0 && cost>=0)) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ÙˆØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­Ø©');
//    const _pid=uid(); db.purchases.push({ id:_pid, productId:pid, qty, unitCost:cost, date: buyDate.value || nowISO() });
//    try{ const pn=(db.products.find(x=>x.id===pid)?.name)||''; recordAudit('add','purchases', _pid, pn, qty);}catch{}
//    saveDB(db); buyQty.value=''; buyCost.value=''; refreshAll();
//  };
// Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¶Ø¹ Ø§Ù„Ø¯Ø§Ù„ØªÙŠÙ† global Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
//function ensureCounters() {
//  db.counters = db.counters || {};
//  if (typeof db.counters.nextPo !== 'number') db.counters.nextPo = 1001; // Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ù€Ø©
//}
//function nextPo() {
//  ensureCounters();
//  const n = db.counters.nextPo;
//  db.counters.nextPo++;
//  if (typeof saveDB === 'function') saveDB(db);
//  return n;/
//}

function renderPurchases() {
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if (!buyProduct) return;

  // 1) ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  buyProduct.innerHTML =
    '<option value="">â€” Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ â€”</option>' +
    db.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

  // 2) Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯ÙŠÙ† + Ø¨Ø§Ø¯Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: Ù†Ù†Ø´Ø¦Ù‡Ø§ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡
  // 2) Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯ÙŠÙ† + Ø¨Ø§Ø¯Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: Ø¯Ø§Ø®Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© (poDraftBox)
ensureCounters();
const poBox = document.getElementById('poDraftBox');
if (poBox && !document.getElementById('supName')) {
  poBox.insertAdjacentHTML('afterbegin', `
    <div id="supFields" class="flex" style="gap:8px;margin-bottom:8px;align-items:center">
      <span id="poPreview" class="tag" title="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¯Ù…">#${db.counters?.nextPo ?? 1001}</span>
      <input id="supName" data-i18n-placeholder="supplierNamePlaceholder" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
      <input id="supPhone" data-i18n-placeholder="supplierPhonePlaceholder" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
    </div>
  `);
}
// Update PO preview badge after supplier fields are added
const poPreview = document.getElementById('poPreview');
if (poPreview) poPreview.textContent = '#' + (db.counters?.nextPo ?? 1001);

// Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
const purchasesSection = document.querySelector('[data-tab="purchases"] .grid');
if (purchasesSection && !document.getElementById('poDraftBox')){
  purchasesSection.insertAdjacentHTML('beforeend', `
    <div class="g12">
      <div id="poDraftBox" class="panel" style="margin-top:10px">
      <div class="flex">
        <strong data-i18n="purchaseDraftTitle">Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</strong>
        <span class="tag" style="margin-inline-start:auto"><span data-i18n="nextPOLabel">PO Ø§Ù„Ù‚Ø§Ø¯Ù…:</span> <span id="poPreview2">#${db.counters?.nextPo ?? 1001}</span></span>
      </div>
      <div class="flex" style="gap:8px;margin:8px 0">
        <button id="savePO" class="btn-primary" type="button" data-i18n="btnSaveInvoice">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        <button id="printDraft" class="btn-muted" type="button" data-i18n="btnPrintDraft">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
        <button id="clearDraft" class="btn-danger" type="button" data-i18n="btnClearDraft">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
      </div>
      <table id="poDraftTable">
        <thead><tr><th data-i18n="thProduct">Ø§Ù„Ù…Ù†ØªØ¬</th><th data-i18n="thQuantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th data-i18n="thUnitCostDraft">ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th data-i18n="thTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th id="poDraftTotal">0.00</th><th></th></tr></tfoot>
      </table>
      </div>
    </div>
  `);
}
const poPrev2 = document.getElementById('poPreview2');
if (poPrev2) poPrev2.textContent = '#' + (db.counters?.nextPo ?? 1001);

// Ø£ÙˆÙ„ Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
renderPurchaseDraft();

  // 3) Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶
  const tbody = document.querySelector('#purchasesTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const pmap = productMap();
  for (const r of db.purchases) {
    const tr = document.createElement('tr');
    const total = (Number(r.qty) || 0) * (Number(r.unitCost) || 0);
    tr.innerHTML = `
      <td>${r.date || ''}</td>
      <td>${pmap.get(r.productId)?.name || 'â€”'}</td>
      <td>${r.qty}</td>
      <td>${(r.unitCost || 0).toFixed(2)}</td>
      <td>${total.toFixed(2)}</td>
      <td>${r.supplier || ''}</td>
      <td>${r.supplierPhone || ''}</td>
      <td>${r.po ? ('#' + r.po) : ''}</td>
      <td><button data-del="${r.id}" class="btn-danger" type="button">${getTranslation(getUISettings().language, 'btnDelete')}</button></td>
    `;
    tbody.appendChild(tr);
  }

  // 4) Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡: Ù†Ø±Ø¨Ø·Ù‡ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆÙ†Ø¶ÙŠÙ supplier + po
// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙÙˆØ±ÙŠ
const addBtn = document.getElementById('addPurchase');
if (addBtn && !addBtn.__boundDraft){
  addBtn.__boundDraft = true;
  addBtn.onclick = () => {
    const prodId = buyProduct.value;
    const qty  = Number(buyQty?.value)||0;
    const cost = Number(buyCost?.value)||0;
    if(!prodId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
    if(qty<=0)  return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©');
    if(cost<0)  return alert('Ø£Ø¯Ø®Ù„ ØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­Ø©');

    purchaseDraft.push({ productId: prodId, qty, unitCost: cost });
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ÙŠØ©
    if(buyQty)  buyQty.value = '';
    if(buyCost) buyCost.value = '';
    if(buyProduct) buyProduct.value = '';
    renderPurchaseDraft();
  };
}
// Helper function to clear supplier fields
function clearSupplierFields() {
  const supNameEl = document.getElementById('supName');
  const supPhoneEl = document.getElementById('supPhone');
  if (supNameEl) supNameEl.value = '';
  if (supPhoneEl) supPhoneEl.value = '';
}

// Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù†Ø´Ø§Ø¡ PO ÙˆØ§Ø­Ø¯ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³ÙˆØ¯Ø©)
const btnSavePO = document.getElementById('savePO');
if (btnSavePO && !btnSavePO.__bound){
  btnSavePO.__bound = true;
  btnSavePO.onclick = ()=>{
    if(purchaseDraft.length===0) return alert('Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙØ§Ø±ØºØ©');

    const supplier      = (document.getElementById('supName')?.value||'').trim();
    const supplierPhone = (document.getElementById('supPhone')?.value||'').trim();
    const dateStr = (document.getElementById('buyDate')?.value) || (new Date().toISOString().slice(0,10));
    const po = nextPo();

    const pmap = productMap();
    purchaseDraft.forEach(it=>{
      const id = uid();
      db.purchases.push({
        id, po,
        productId: it.productId,
        qty: it.qty,
        unitCost: it.unitCost,
        date: dateStr,
        supplier, supplierPhone
      });
      try{
        const pn = pmap.get(it.productId)?.name || '';
        recordAudit && recordAudit('add','purchases', id, `PO#${po} | ${pn} Ã—${it.qty}`, it.qty);
      }catch(_){}
    });

    saveDB(db);
    purchaseDraft = [];
    
    // Clear supplier fields after save
    clearSupplierFields();
    
    // Update PO badges
    const poPrev = document.getElementById('poPreview'); if(poPrev) poPrev.textContent = '#' + (db.counters?.nextPo ?? 1001);
    const poPrev2= document.getElementById('poPreview2'); if(poPrev2) poPrev2.textContent= '#' + (db.counters?.nextPo ?? 1001);
    
    renderPurchaseDraft();
    refreshAll();
    
    if(confirm('ØªÙ… Ø§Ù„Ø­ÙØ¸. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¢Ù†ØŸ')){
      printPurchaseByPO(po);
    }
  };
}

const btnClear = document.getElementById('clearDraft');
if (btnClear && !btnClear.__bound){
  btnClear.__bound = true;
  btnClear.onclick = ()=>{
    if(!confirm(getTranslation(getUISettings().language, 'confirmClearDraft'))) return;
    purchaseDraft = [];
    clearSupplierFields(); // Clear supplier fields when clearing draft
    renderPurchaseDraft();
  };
}

const btnPrintDraft = document.getElementById('printDraft');
if (btnPrintDraft && !btnPrintDraft.__bound){
  btnPrintDraft.__bound = true;
  btnPrintDraft.onclick = ()=> printPurchaseDraft();
}


  // 5) Ø­Ø°Ù Ø´Ø±Ø§Ø¡ (ÙƒÙ…Ø§ Ø¹Ù…Ù„ØªÙ Ø³Ø§Ø¨Ù‚Ù‹Ø§)
  tbody.onclick = async (e) => {
    if (e.target.dataset.del) {
      const id = e.target.dataset.del;
      const rec = db.purchases.find(x => x.id === id);
      const pn = (db.products.find(x => x.id === rec.productId)?.name) || '';
      const res = await confirmDeleteUniversal('purchases', id, pn, rec.qty);
      if (!res.ok) return;
      db.purchases = db.purchases.filter(x => x.id !== id);
      saveDB(db); refreshAll();
      // Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨Ø¹Ø¯ increment nextPo + refreshAll()
const poPrev = document.getElementById('poPreview');
if (poPrev) poPrev.textContent = '#' + (db.counters?.nextPo ?? 1001);
      return;
    }
  };
}
    
// Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (PO draft)
let purchaseDraft = []; // [{productId, qty, unitCost}...]

function renderPurchaseDraft(){
  const box = document.getElementById('poDraftBox');
  if(!box) return;
  const table = document.getElementById('poDraftTable');
  if(!table) return;

  const pmap = productMap();
  const tbody = table.tBodies[0];
  tbody.innerHTML = '';

  let sum = 0;
  purchaseDraft.forEach((it, idx)=>{
    const name = pmap.get(it.productId)?.name || 'â€”';
    const lineTotal = (Number(it.qty)||0) * (Number(it.unitCost)||0);
    sum += lineTotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${it.qty}</td><td>${(Number(it.unitCost)||0).toFixed(2)}</td><td>${lineTotal.toFixed(2)}</td>
      <td><button data-rm="${idx}" class="btn-danger" type="button">${getTranslation(getUISettings().language, 'btnDelete')}</button></td>`;
    tbody.appendChild(tr);
  });

  const tfoot = table.tFoot;
  if(tfoot){
    const cell = tfoot.querySelector('th#poDraftTotal');
    if(cell) cell.textContent = sum.toFixed(2);
  }

  tbody.onclick = (e)=>{
    const i = e.target.dataset.rm;
    if(i===undefined) return;
    if(!softConfirm(e.target)) return;
    purchaseDraft.splice(Number(i),1);
    renderPurchaseDraft();
  };
}

function printPurchaseDraft(){
  if(purchaseDraft.length===0) return alert('Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙØ§Ø±ØºØ©');
  const sup = (document.getElementById('supName')?.value||'').trim();
  const tel = (document.getElementById('supPhone')?.value||'').trim();
  const pmap = productMap();
  let rows = '';
  let sub = 0;
  purchaseDraft.forEach(it=>{
    const name = pmap.get(it.productId)?.name || 'â€”';
    const line = (Number(it.qty)||0) * (Number(it.unitCost)||0);
    sub += line;
    rows += `<tr><td>${name}</td><td>${it.qty}</td><td>${(Number(it.unitCost)||0).toFixed(2)}</td><td>${line.toFixed(2)}</td></tr>`;
  });
  const w = window.open('', '_blank');
  w.document.write(`
    <html lang="${getUISettings().language}" dir="${getUISettings().language === 'ar' ? 'rtl' : 'ltr'}"><head><meta charset="utf-8"><title>Ù…Ø³ÙˆØ¯Ø© PO</title>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px;text-align:right}</style>
    </head><body>
      <h2>${getTranslation(getUISettings().language, 'printDraftTitle')}</h2>
      <div>${getTranslation(getUISettings().language, 'supplierLabel')}: ${sup||'-'} &nbsp; | &nbsp; ${getTranslation(getUISettings().language, 'phoneLabel')}: ${tel||'-'}</div>
      <hr>
      <table><thead><tr><th>${getTranslation(getUISettings().language, 'thProduct')}</th><th>${getTranslation(getUISettings().language, 'thQuantity')}</th><th>${getTranslation(getUISettings().language, 'thUnitCostDraft')}</th><th>${getTranslation(getUISettings().language, 'thTotal')}</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><th colspan="3" style="text-align:left">${getTranslation(getUISettings().language, 'thTotal')}</th><th>${sub.toFixed(2)}</th></tr></tfoot>
      </table>
      <div style="margin-top:12px"><button onclick="window.print()">${getTranslation(getUISettings().language, 'btnPrintDraft')}</button></div>
    </body></html>`);
  w.document.close();
}

function printPurchaseByPO(po){
  const list = (db.purchases||[]).filter(r=>r.po === po);
  if(list.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
  const pmap = productMap();
  let rows = ''; let sub = 0; let sup=''; let tel='';
  list.forEach(r=>{
    const name = pmap.get(r.productId)?.name || 'â€”';
    const line = (Number(r.qty)||0)*(Number(r.unitCost)||0);
    sub += line; rows += `<tr><td>${name}</td><td>${r.qty}</td><td>${(Number(r.unitCost)||0).toFixed(2)}</td><td>${line.toFixed(2)}</td></tr>`;
    sup = r.supplier || sup; tel = r.supplierPhone || tel;
  });
  const w = window.open('', '_blank');
  w.document.write(`
    <html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>PO #${po}</title>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px;text-align:right}</style>
    </head><body>
      <h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª #${po}</h2>
      <div>Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯: ${sup||'-'} &nbsp; | &nbsp; Ù‡Ø§ØªÙ: ${tel||'-'}</div>
      <hr>
      <table><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${sub.toFixed(2)}</th></tr></tfoot>
      </table>
      <div style="margin-top:12px"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
    </body></html>`);
  w.document.close();
}


  // ====== Sales ======
  let currentOrder = { items: [] };
  const sellProduct = document.getElementById('sellProduct');
  const sellQty = document.getElementById('sellQty');
  const sellPrice = document.getElementById('sellPrice');
  const lineDiscType = document.getElementById('lineDiscType');
  const lineDiscVal = document.getElementById('lineDiscVal');
  const orderDate = document.getElementById('orderDate'); if(orderDate) orderDate.value = nowISO();
  const deliveryFee = document.getElementById('deliveryFee');
  const cartTableBody = ()=> document.querySelector('#cartTable tbody');
  const orderTotalCell = document.getElementById('orderTotalCell');

  function getProductPrice(pid){ return (db.products.find(p=>p.id===pid)?.price)||0; }
  function lineTotal(qty, unitPrice, discType, discValue){
    qty = Number(qty)||0; unitPrice = Number(unitPrice)||0; discValue = Number(discValue)||0;
    let gross = qty*unitPrice; let disc = 0;
    if(discType==='amount') disc = discValue; else if(discType==='percent') disc = gross*(discValue/100);
    return Math.max(0, gross - disc);
  }

  function renderCart(){
    const tbody = cartTableBody(); if(!tbody) return; tbody.innerHTML='';
    let total = 0; const pmap = productMap();
    currentOrder.items.forEach((it, idx)=>{
      const lt = lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue); total += lt;
      const tr = document.createElement('tr');
      const discLabel = it.discountType==='amount' ? `${(Number(it.discountValue)||0).toFixed(2)} AED` : (it.discountType==='percent'? `${(Number(it.discountValue)||0).toFixed(2)}%` : 'â€”');
      tr.innerHTML = `<td>${pmap.get(it.productId)?.name||'â€”'}</td><td>${it.qty}</td><td>${(Number(it.unitPrice)||0).toFixed(2)}</td><td>${discLabel}</td><td>${lt.toFixed(2)}</td>
      <td><button data-del-line="${idx}" class="btn-danger" type="button">${getTranslation(getUISettings().language, 'btnDelete')}</button></td>`;
      tbody.appendChild(tr);
    });
    const del = Number(deliveryFee?.value)||0;
    if(orderTotalCell) orderTotalCell.textContent = (total + del).toFixed(2);
    tbody.onclick = (e)=>{ const i = e.target.dataset.delLine; if(i===undefined) return; if(!softConfirm(e.target)) return; currentOrder.items.splice(Number(i),1); renderCart(); };
  }

  document.getElementById('addLine').onclick = ()=>{
    const pid = sellProduct.value; if(!pid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
    const qty = Number(sellQty.value)||0; if(qty<=0) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
    const up = Number(sellPrice.value)||0; if(up<0) return alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­');
    currentOrder.items.push({ productId: pid, qty, unitPrice: up, discountType: lineDiscType.value, discountValue: Number(lineDiscVal.value)||0 });
    renderCart();
  };

  document.getElementById('saveOrder').onclick = ()=>{
    if(currentOrder.items.length===0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
    const stats = calcStats();
    for(const it of currentOrder.items){
      const s = stats.find(x=>x.id===it.productId); if(s && s.stock < it.qty){
        if(!confirm('Ù‡Ù†Ø§Ùƒ ØµÙ†Ù ÙƒÙ…ÙŠØªÙ‡ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
        break;
      }
    }
    const delFee = Number(deliveryFee?.value)||0;
    const custName = document.getElementById('customerName')?.value || '';
    const custPhone = document.getElementById('customerPhone')?.value || '';
    const _oid = uid(); db.sales.push({ id: _oid, date: (orderDate && orderDate.value) || nowISO(), items: deepClone(currentOrder.items), deliveryFee: delFee, customerName: custName, customerPhone: custPhone });
    try{ recordAudit('add','sales', _oid, 'order', currentOrder.items.length);}catch{} saveDB(db); currentOrder.items = []; 
    // Clear customer fields after saving
    if(document.getElementById('customerName')) document.getElementById('customerName').value = '';
    if(document.getElementById('customerPhone')) document.getElementById('customerPhone').value = '';
    renderSales(); renderReports();
    alert(getTranslation(getUISettings().language, 'orderSaved'));
  };

  function renderOrdersList(){
    const tbody = document.querySelector('#ordersTable tbody'); if(!tbody) return; tbody.innerHTML='';
    for(const o of db.sales){
      const itemCount = Array.isArray(o.items)? o.items.length : 1;
      let total=0;
      if(Array.isArray(o.items)){
        for(const it of o.items){ total += lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue); }
      } else { total = (Number(o.qty)||0)*(Number(o.unitPrice)||0); }
      total += Number(o.deliveryFee||0);
      const tr = document.createElement('tr');
      const customerName = o.customerName || 'â€”';
      const customerPhone = o.customerPhone || 'â€”';
      tr.innerHTML = `<td>${o.date||''}</td><td>${itemCount}</td><td>${total.toFixed(2)}</td><td>${customerName}</td><td>${customerPhone}</td>
      <td class="flex"><button data-inv="${o.id}" type="button">${getTranslation(getUISettings().language, 'btnInvoice')}</button><button data-del-order="${o.id}" class="btn-danger" type="button">${getTranslation(getUISettings().language, 'btnDelete')}</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.onclick = async (e)=>{
  const idDel = e.target.dataset.delOrder;
  const idInv = e.target.dataset.inv;

  if (idDel) {
    const res = await confirmDeleteUniversal('sales', idDel, 'order');
    if (!res.ok) return;
    db.sales = db.sales.filter(x => x.id !== idDel);
    saveDB(db); renderSales(); renderReports();
    return;
  }

  if (idInv) { openInvoice(idInv); return; }
};
  }

  function renderSales(){
    if(sellProduct){
      sellProduct.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ â€”</option>' + db.products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      sellProduct.onchange = ()=>{ sellPrice.value = getProductPrice(sellProduct.value).toFixed(2); };
      sellPrice.value = sellProduct.value ? getProductPrice(sellProduct.value).toFixed(2) : '';
    }
    renderCart();
    renderOrdersList();
  }

  // ====== Invoice ======
  function fmt(n){ return (Number(n)||0).toFixed(2); }
  function openInvoice(orderId){
    const o = db.sales.find(x=>x.id===orderId); if(!o) return alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const pmap = productMap();
    let sub=0;
    const rows = (o.items||[]).map(it=>{
      const name = pmap.get(it.productId)?.name || 'â€”';
      const lt = lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue);
      sub += lt;
      const discLabel = it.discountType==='amount' ? `${fmt(it.discountValue)} AED` :
                        (it.discountType==='percent' ? `${fmt(it.discountValue)}%` : 'â€”');
      return `<tr><td>${name}</td><td>${it.qty}</td><td>${fmt(it.unitPrice)}</td><td>${discLabel}</td><td>${fmt(lt)}</td></tr>`;
    }).join('');
    const del = Number(o.deliveryFee||0);
    const total = sub + del;
    const win = window.open('', '_blank');
    win.document.write(`
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8" />
        <title>ÙØ§ØªÙˆØ±Ø©</title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px;color:#111}
          h2{margin:0 0 12px 0}
          table{width:100%;border-collapse:collapse;margin-top:10px}
          th,td{border:1px solid #ccc;padding:8px;text-align:right}
          tfoot th{background:#f7f7f7}
        </style>
      </head>
      <body>
        <h2>ÙØ§ØªÙˆØ±Ø©</h2>
        <div>ØªØ§Ø±ÙŠØ®: ${o.date||''}</div>
        ${o.customerName ? `<div>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${o.customerName}</div>` : ''}
        ${o.customerPhone ? `<div>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${o.customerPhone}</div>` : ''}
        <hr/>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr><th colspan="4" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ</th><th>${fmt(sub)} AED</th></tr>
            <tr><th colspan="4" style="text-align:left">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</th><th>${fmt(del)} AED</th></tr>
            <tr><th colspan="4" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</th><th>${fmt(total)} AED</th></tr>
          </tfoot>
        </table>
        <div style="margin-top:16px">
          <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
        </div>
      </body>
      </html>
    `);
    win.document.close();
  }

  // ====== Reports ======
  function currency(n){ return (Number(n)||0).toFixed(2) + ' AED'; }
  function renderReports(){
    const stats = calcStats();
    const invValue = sum(stats.map(s=>s.stock * s.avgCost));
    const revenue = sum(stats.map(s=>s.revenue));
    const deliverySum = (db.sales||[]).reduce((a,b)=> a + (Number(b.deliveryFee||0)), 0);
    const cogs = sum(stats.map(s=>s.cogs));
    const profit = (revenue + deliverySum) - cogs;

    const kpis = document.getElementById('kpis'); if(kpis){
      kpis.innerHTML = '';
      const items = [
        {label:'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', value: currency(invValue)},
        {label:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', value: currency(revenue)},
        {label:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„', value: currency(deliverySum)},
        {label:'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)', value: currency(profit)},
      ];
      for(const it of items){
        const d = document.createElement('div'); d.className='kpi';
        d.innerHTML = `<div class="hint">${it.label}</div><div style="font-size:22px;margin-top:6px">${it.value}</div>`;
        kpis.appendChild(d);
      }
    }

    const lowT = document.querySelector('#lowStockTable tbody'); if(lowT){
      lowT.innerHTML='';
      const threshold = Number(db.settings.lowStockThreshold)||0;
      for(const s of stats){
        const tr = document.createElement('tr');
        let tag = '<span class="tag ok">Ø¬ÙŠØ¯</span>';
        if(s.stock <= threshold) tag = '<span class="tag danger">Ù…Ù†Ø®ÙØ¶</span>';
        else if(s.stock <= threshold*1.5) tag = '<span class="tag warn">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶</span>';
        tr.innerHTML = `<td>${s.name}</td><td>${s.stock}</td><td>${tag}</td>`;
        lowT.appendChild(tr);
      }
    }

    const topT = document.querySelector('#topProductsTable tbody'); if(topT){
      topT.innerHTML='';
      const top = [...stats].sort((a,b)=>b.revenue - a.revenue).slice(0,10);
      for(const s of top){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.name}</td><td>${s.soldQty||0}</td><td>${currency(s.revenue)}</td>`;
        topT.appendChild(tr);
      }
    }
  }

  // ====== Dashboard ======
  function renderDashboard() {
    if (typeof window.dashboardModule === 'undefined') return;
    
    // Initialize dashboard state
    let currentPeriod = 'today';
    let customStartDate = '';
    let customEndDate = '';
    
    // Period selection handling
    const periodButtons = document.querySelectorAll('[data-period]');
    const customDateRange = document.getElementById('customDateRange');
    const customStart = document.getElementById('customStartDate');
    const customEnd = document.getElementById('customEndDate');
    
    function updatePeriodSelection(period) {
      currentPeriod = period;
      periodButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      customDateRange.hidden = period !== 'custom';
      updateDashboard();
    }
    
    function updateDashboard() {
      customStartDate = customStart?.value || '';
      customEndDate = customEnd?.value || '';
      
      // Update KPIs
      const kpis = window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate);
      renderKPIs(kpis);
      
      // Update chart
      updateChart(kpis.dailyData);
      
      // Update summary table
      const summary = window.dashboardModule.generateDailySummary(currentPeriod, customStartDate, customEndDate);
      renderSummaryTable(summary);
    }
    
    function renderKPIs(kpis) {
      const kpiContainer = document.getElementById('dashboardKpis');
      if (!kpiContainer) return;
      
      kpiContainer.innerHTML = '';
      const items = [
        {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', value: currency(kpis.totalSales)},
        {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', value: currency(kpis.totalPurchases)},
        {label:'Ø§Ù„Ø±Ø¨Ø­', value: currency(kpis.profit)},
        {label:'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', value: currency(kpis.stock)},
      ];
      
      for(const item of items) {
        const d = document.createElement('div');
        d.className = 'kpi';
        d.innerHTML = `<div class="hint">${item.label}</div><div style="font-size:22px;margin-top:6px">${item.value}</div>`;
        kpiContainer.appendChild(d);
      }
    }
    
    function updateChart(dailyData) {
      const dataset = document.getElementById('chartDataset')?.value || 'sales';
      const chartType = document.getElementById('chartType')?.value || 'line';
      window.dashboardModule.renderChart('dashboardChart', dailyData, chartType, dataset);
    }
    
    function renderSummaryTable(summary) {
      const tbody = document.querySelector('#dashboardSummaryTable tbody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      for(const day of summary) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${day.date}</td>
          <td>${currency(day.sales)}</td>
          <td>${currency(day.purchases)}</td>
          <td>${currency(day.profit)}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    
    // Event listeners
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => updatePeriodSelection(btn.dataset.period));
    });
    
    if (customStart) customStart.addEventListener('change', updateDashboard);
    if (customEnd) customEnd.addEventListener('change', updateDashboard);
    
    const chartDataset = document.getElementById('chartDataset');
    const chartType = document.getElementById('chartType');
    if (chartDataset) chartDataset.addEventListener('change', () => updateChart(window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate).dailyData));
    if (chartType) chartType.addEventListener('change', () => updateChart(window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate).dailyData));
    
    // Initialize with today's data
    updatePeriodSelection('today');
  }

  // ====== Settings ======
  const lowStockThreshold = document.getElementById('lowStockThreshold');
  function renderSettings(){ if(lowStockThreshold) lowStockThreshold.value = db.settings.lowStockThreshold; }
  document.getElementById('saveSettings').onclick = ()=>{ db.settings.lowStockThreshold = Number(lowStockThreshold.value)||0; try{ recordAudit('edit','settings','', 'lowStockThreshold='+db.settings.lowStockThreshold);}catch{} saveDB(db); alert(getTranslation(getUISettings().language, 'settingsSaved')); refreshAll(); };

  // ====== Backup / Restore / Reset ======
  document.getElementById('btnBackup').onclick = ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mini-store-backup.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
  };
  document.getElementById('btnRestore').onclick = ()=> document.getElementById('restoreFile').click();
  document.getElementById('restoreFile').onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = ()=>{ try{ db = JSON.parse(reader.result); saveDB(db); refreshAll(); alert(getTranslation(getUISettings().language, 'backupRestored')); }catch{ alert(getTranslation(getUISettings().language, 'invalidFile')); } }; reader.readAsText(file);
    e.target.value='';
  };
  const btnResetEl = document.getElementById('btnReset');
  btnResetEl.onclick = ()=>{
    if(!softConfirm(btnResetEl,'ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø©ØŸ')) return;
    db = deepClone(defaults); saveDB(db); refreshAll(); alert(getTranslation(getUISettings().language, 'systemReset'));
  };

  // ====== Soft Confirm ======
  function softConfirm(btn, labelConfirm='ØªØ£ÙƒÙŠØ¯ØŸ'){
    if(!btn.dataset.arm){
      btn.dataset.arm = '1';
      const old = btn.textContent; btn.dataset.oldText = old;
      btn.textContent = labelConfirm;
      setTimeout(()=>{ btn.dataset.arm=''; btn.textContent = btn.dataset.oldText||old; }, 2000);
      return false;
    }
    btn.dataset.arm='';
    btn.textContent = btn.dataset.oldText||btn.textContent;
    return true;
  }
  //========New=======
  // ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù…ÙˆØ­Ù‘Ø¯ + ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
async function confirmDeleteUniversal(module, id, name = '', extraQty = '') {
  // ØµÙ„Ø§Ø­ÙŠØ§Øª
  if (typeof can === 'function' && !can(module, 'delete')) {
    alert(getTranslation(getUISettings().language, 'alertNoDeletePermission'));
    return { ok: false };
  }

  const title = getTranslation(getUISettings().language, 'deleteConfirmTitle')
    .replace('{name}', name ? 'Â«' + name + 'Â»' : getTranslation(getUISettings().language, 'genericItem'))
    .replace('{module}', module);
  if (!confirm(title)) return { ok: false };

  // Ø³Ø¨Ø¨ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
  const reason = prompt(getTranslation(getUISettings().language, 'deleteReasonPrompt')) || '';

  try {
    if (typeof recordAudit === 'function') {
      const details = name ? `${name}${reason ? ' â€” ' + reason : ''}` : reason;
      recordAudit('delete', module, id || '', details, extraQty);
    }
  } catch (_) {}

  return { ok: true, reason };
}
  // ====== Export CSV ======
  function exportTableToCSV(tableId, filename, mode='window'){
    const table = document.getElementById(tableId);
    if(!table){ alert(getTranslation(getUISettings().language, 'tableNotFound')); return; }

    const headRow = table.tHead && table.tHead.rows[0] ? table.tHead.rows[0] : null;
    const totalCols = headRow ? headRow.cells.length : (table.rows[0] ? table.rows[0].cells.length : 0);
    const includeIdx = Array.from({length: totalCols}, (_,i)=>i).filter(i=>{
      const th = headRow ? headRow.cells[i] : null;
      if(!th) return true;
      const text = (th.textContent||'').replace(/\s+/g,' ').trim();
      const interactive = th.querySelector && th.querySelector('button,input,select');
      return text !== '' && !interactive;
    });

    const allRows = Array.from(table.querySelectorAll('thead tr, tbody tr, tfoot tr'));
    const csv = allRows.map(row => {
      const cells = Array.from(row.children);
      const parts = includeIdx.map(i=>{
        const cell = cells[i]; if(!cell) return '';
        if(cell.querySelector && cell.querySelector('button,input,select')) return '';
        let text = (cell.textContent||'').replace(/\s+/g,' ').trim();
        if (text.includes('"') || text.includes(',')) text = '"' + text.replace(/"/g,'""') + '"';
        return text;
      });
      return parts.join(',');
    }).join('\n');

    const csvWithBom = "\uFEFF" + csv;
    const safeName = (filename && filename.endsWith('.csv')) ? filename : (filename || 'export') + '.csv';

    if (mode === 'window'){
      const url = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvWithBom);
      const w = window.open(url, '_blank');
      if(!w || w.closed){
        try{
          const blob = new Blob([csvWithBom], {type:'text/csv;charset=utf-8;'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = safeName;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          setTimeout(()=> URL.revokeObjectURL(a.href), 500);
        }catch(err){ console.error('CSV open/download failed', err); alert('ØªØ¹Ø°Ø± ÙØªØ­/ØªÙ†Ø²ÙŠÙ„ CSV: '+err.message); }
      }
      return;
    }

    try{
      const blob = new Blob([csvWithBom], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = safeName;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=> URL.revokeObjectURL(a.href), 500);
    }catch(err){ console.error('CSV download failed', err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: '+err.message); }
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-export][data-table]');
    if(!btn) return;
    try{ exportTableToCSV(btn.dataset.table, btn.dataset.filename || 'export.csv', 'window'); }
    catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: '+ err.message); }
  });

  // ====== Refresh All ======
  function refreshAll(){
    renderProducts(); renderPurchases(); renderSales(); renderReports(); renderSettings();
    try { if (typeof renderAudit === 'function') renderAudit(); } catch (e) { console.warn('renderAudit error', e); }
    try { if (typeof renderUsersAdmin === 'function') renderUsersAdmin(); } catch (e) { console.warn('renderUsersAdmin error', e); }
    try { if (typeof renderDashboard === 'function') renderDashboard(); } catch (e) { console.warn('renderDashboard error', e); }
  }

  // ====== Auth UI ======
  const authOverlay = document.getElementById('authOverlay');
  const authBody = document.getElementById('authBody');
  const authTitle = document.getElementById('authTitle');
  const appRoot = document.getElementById('appRoot');
  const whoami = document.getElementById('whoami');
  const btnLogout = document.getElementById('btnLogout');
  btnLogout.onclick = ()=>{ clearSession(); location.reload(); };

  function showAuth(){
    authOverlay.classList.remove('is-hidden');
    authOverlay.hidden = false;
    authOverlay.style.display = 'flex';
    authOverlay.setAttribute('aria-hidden','false');
    appRoot.hidden = true;
  }
  function hideAuth(){
    authOverlay.classList.add('is-hidden');
    authOverlay.hidden = true;
    authOverlay.style.display = 'none';
    authOverlay.setAttribute('aria-hidden','true');
    appRoot.hidden = false;
  }

  function renderLogin(){
    authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    authBody.innerHTML = `
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="loginUser" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="loginPass" type="password" />
      <div class="flex" style="margin-top:10px">
        <button id="doLogin" class="btn-primary" type="button">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div class="hint">Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¨Ø¹Ø¯ØŒ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    `;
    document.getElementById('doLogin').onclick = doLogin;
  }

  function renderCreate(){
    authTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ±';
    authBody.innerHTML = `
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="regUser" placeholder="Ù…Ø«Ø§Ù„: admin" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="regPass" type="password" />
      <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="regPass2" type="password" />
      <div class="flex" style="margin-top:10px">
        <button id="doCreate" class="btn-primary" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
      </div>
      <div class="hint">ØªÙØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ´ÙÙ‘Ø±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
    `;
    document.getElementById('doCreate').onclick = doCreate;
  }

  async function doCreate(){
    const u = document.getElementById('regUser').value.trim();
    const p1 = document.getElementById('regPass').value;
    const p2 = document.getElementById('regPass2').value;
    if(!u || !p1) return alert(getTranslation(getUISettings().language, 'enterUsernamePassword'));
    if(p1 !== p2) return alert(getTranslation(getUISettings().language, 'passwordConfirmMismatch'));
    const users = loadUsers();
    if(users.find(x=>x.username.toLowerCase()===u.toLowerCase())) return alert(getTranslation(getUISettings().language, 'usernameAlreadyExists'));
    const salt = genSalt();
    const hash = await sha256(p1 + salt);
    users.push({ username:u, salt, hash });
    saveUsers(users);
    alert(getTranslation(getUISettings().language, 'accountCreated'));
    renderLogin();
  }

  async function doLogin(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    const users = loadUsers();
    const rec = users.find(x=>x.username.toLowerCase()===u.toLowerCase());
    if(!rec) return alert(getTranslation(getUISettings().language, 'invalidCredentials'));
    const hash = await sha256(p + rec.salt);
    if(hash !== rec.hash) return alert(getTranslation(getUISettings().language, 'invalidCredentials'));
    setSession(rec.username);
    startApp(rec.username);
  }

  async function startApp(username){
    currentUser = username;
    dbKey = dbKeyBase; try { const legacy = localStorage.getItem(dbKeyBase + ':' + username); if(legacy && !localStorage.getItem(dbKey)) localStorage.setItem(dbKey, legacy); } catch(e){}
    db = loadDB();
    App.setDB(db);
    whoami.textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + username;
    btnLogout.hidden = false;
    hideAuth();
    applyUISettings(); // Apply UI settings on startup
    activateTab(getLastTab());
  }

  // ====== Change password ======
  document.getElementById('btnChangePass').onclick = async ()=>{
    const cur = document.getElementById('curPass').value;
    const n1 = document.getElementById('newPass').value;
    const n2 = document.getElementById('newPass2').value;
    if(!n1 || n1 !== n2) return alert(getTranslation(getUISettings().language, 'passwordMismatch'));
    const users = loadUsers();
    const rec = users.find(x=>x.username===currentUser);
    if(!rec) return alert(getTranslation(getUISettings().language, 'accountNotFound'));
    const hcur = await sha256(cur + rec.salt);
    if(hcur !== rec.hash) return alert(getTranslation(getUISettings().language, 'wrongCurrentPassword'));
    rec.salt = genSalt();
    rec.hash = await sha256(n1 + rec.salt);
    saveUsers(users);
    alert(getTranslation(getUISettings().language, 'passwordChanged'));
    document.getElementById('curPass').value = document.getElementById('newPass').value = document.getElementById('newPass2').value = '';
  };

  // ====== General Settings Event Handlers ======
  // Language change
  document.addEventListener('DOMContentLoaded', () => {
    const uiLanguage = document.getElementById('uiLanguage');
    const uiTheme = document.getElementById('uiTheme');
    const uiAccent = document.getElementById('uiAccent');
    const shopName = document.getElementById('shopName');
    const shopLogoFile = document.getElementById('shopLogoFile');
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    
    if (uiLanguage) {
      uiLanguage.onchange = () => {
        const ui = getUISettings();
        ui.language = uiLanguage.value;
        saveUISettings(ui);
        applyUISettings();
      };
    }
    
    if (uiTheme) {
      uiTheme.onchange = () => {
        const ui = getUISettings();
        ui.theme = uiTheme.value;
        saveUISettings(ui);
        applyUISettings();
      };
    }
    
    if (uiAccent) {
      uiAccent.onchange = () => {
        const ui = getUISettings();
        ui.accent = uiAccent.value;
        saveUISettings(ui);
        applyUISettings();
      };
    }
    
    if (shopName) {
      shopName.onchange = () => {
        const ui = getUISettings();
        ui.shopName = shopName.value;
        saveUISettings(ui);
        applyUISettings();
      };
    }
    
    if (shopLogoFile) {
      shopLogoFile.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            const ui = getUISettings();
            ui.shopLogo = reader.result;
            saveUISettings(ui);
            applyUISettings();
            renderGeneralSettings();
          };
          reader.readAsDataURL(file);
        }
      };
    }
    
    if (removeLogoBtn) {
      removeLogoBtn.onclick = () => {
        const ui = getUISettings();
        ui.shopLogo = '';
        saveUISettings(ui);
        applyUISettings();
        renderGeneralSettings();
      };
    }
    
    // Color swatches
    document.querySelectorAll('.color-swatch').forEach(swatch => {
      swatch.onclick = () => {
        const ui = getUISettings();
        ui.accent = swatch.dataset.color;
        document.getElementById('uiAccent').value = ui.accent;
        saveUISettings(ui);
        applyUISettings();
      };
    });
  });

  // ====== Boot ======
  (async function boot(){
    const session = getSession();
    const users = loadUsers();
    showAuth();
    if(!users.length){
      renderCreate();
    }else if(session && session.username){
      await startApp(session.username);
    }else{
      renderLogin();
    }
  })();
  </script>

  <!-- LILIJA modules -->
  <script src="modules/utils.js"></script>
  <script src="modules/auth.js"></script>
  <script src="modules/data.js"></script>
  <script src="modules/users_admin.js"></script>
  <script src="modules/audit_log.js"></script>
  <script src="modules/dashboard.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize language from localStorage
      initializeLanguage();
      
      if (document.querySelector('.tab.active')?.dataset.tab === 'audit' && typeof renderAudit === 'function') {
        renderAudit();
      }
    });
  </script>

</body>
</html>
