<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙŠÙ„ÙŠØ¬Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± (v1.1.0)</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#0b1023,#0a0f1c);color:var(--text)}
    header{position:sticky;top:0;background:#0b1023cc;backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid #1e293b}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    h2{margin:16px 0 8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 12px;border:1px solid #334155;border-radius:10px;background:#0b1224;cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px #22d3ee22}
    .panel{background:#0b1224;border:1px solid #1f2a44;border-radius:14px;padding:14px;margin-top:14px}
    label{display:block;margin:8px 0 4px}
    input,select{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #334155;background:#0a142b;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .g6{grid-column:span 6}.g4{grid-column:span 4}.g3{grid-column:span 3}.g8{grid-column:span 8}.g12{grid-column:span 12}
    @media(max-width:900px){.g6,.g4,.g3,.g8{grid-column:span 12}}
    button{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#101a34;color:var(--text);cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#0b1023;border:none}
    .btn-danger{background:#2a0a0a;border:1px solid #7f1d1d}
    .btn-muted{background:#0b1224;border:1px solid #334155}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px dashed #25324d;padding:10px;text-align:right}
    tr:hover{background:#0c1530}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{border:1px solid #20304e;background:#0b1224;border-radius:14px;padding:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:12px;border:1px solid #32435f}
    .tag.warn{border-color:#8b5cf6;color:#e9d5ff}
    .tag.danger{border-color:#ef4444;color:#fecaca}
    .tag.ok{border-color:#22c55e;color:#bbf7d0}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-inline-start:auto}
    .hint{font-size:12px;opacity:.75}

    /* Auth overlay */
    .overlay{position:fixed;inset:0;background:#0b1023f0;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:9999}
    .card{width:min(94vw,420px);background:#0b1224;border:1px solid #20304e;border-radius:14px;padding:18px}
    .card h3{margin:0 0 8px 0}
    .is-hidden{display:none !important;visibility:hidden !important;opacity:0 !important}
  </style>
</head>
<body>
  <header>
    <div class="wrap flex">
      <h1><svg id="logoLilija" viewBox="0 0 200 200" width="20" height="20" aria-hidden="true" style="vertical-align:-3px;margin-inline-end:6px"><circle cx="100" cy="100" r="88" fill="none" stroke="#e6eef9" stroke-width="12"/><path d="M60 60 v50 c0 25 20 35 40 35 h35" fill="none" stroke="#e6eef9" stroke-width="12" stroke-linecap="round"/><rect x="86" y="132" width="14" height="14" rx="3" fill="#e6eef9"/><rect x="112" y="132" width="14" height="14" rx="3" fill="#e6eef9"/></svg>Ù„ÙŠÙ„ÙŠØ¬Ø© â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± (v1.1.0) <small id="bootChecks" class="hint" style="font-weight:normal;font-size:12px;opacity:.8"></small></h1>
      <div class="right flex">
        <span id="whoami" class="hint"></span>
        <button id="btnLogout" class="btn-muted" type="button" hidden>ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <button id="btnBackup" class="btn-muted" type="button">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <input type="file" id="restoreFile" style="display:none" accept="application/json" />
        <button id="btnRestore" class="btn-muted" type="button">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
        <button id="btnReset" class="btn-danger" type="button">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </div>
  </header>
  <!-- Auth Overlay -->
  <div id="authOverlay" class="overlay is-hidden" aria-hidden="true">
    <div class="card" id="authCard">
      <h3 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div id="authBody"></div>
    </div>
  </div>

  <main class="wrap" id="appRoot" hidden>
    <div class="tabs" id="tabs"></div>

    <!-- Ù…Ù†ØªØ¬Ø§Øª -->
    <section class="panel" data-tab="products">
      <h2>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div class="grid">
        <div class="g4">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="pName" placeholder="Ù…Ø«Ù„: ØªÙ…Ø± Ø®Ù„Ø§Øµ 500Øº" />
          <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ / SKU</label><input id="pSku" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          <label>Ø§Ù„ÙØ¦Ø©</label><input id="pCat" placeholder="Ù…Ø«Ù„: ØªÙ…ÙˆØ±" />
          <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (AED)</label><input id="pPrice" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 15.00" />
          <button class="btn-primary" id="addProduct" type="button">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
          <div class="hint">ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
        </div>
        <div class="g8">
          <div class="flex"><div class="hint">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div><div class="right"><button id="exportProducts" type="button" class="btn-muted" data-export="1" data-table="productsTable" data-filename="products.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="productsTable">
            <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>SKU</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù…Ø´ØªØ±ÙŠØ§Øª -->
    <section class="panel" data-tab="purchases" hidden>
      <h2>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙˆØ§Ø±Ø¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†)</h2>
      <div class="grid">
        <div class="g4">
          <label>Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="buyProduct"></select>
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="buyQty" type="number" step="1" min="1" />
          <label>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© (AED)</label><input id="buyCost" type="number" step="0.01" />
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="buyDate" type="date" />
          <button class="btn-primary" id="addPurchase" type="button">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
        </div>
        <div class="g8">
          <div class="flex"><div class="hint">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div><div class="right"><button id="exportPurchases" type="button" class="btn-muted" data-export="1" data-table="purchasesTable" data-filename="purchases.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="purchasesTable">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>PO#</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <section class="panel" data-tab="sales" hidden>
      <h2>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù)</h2>
      <div class="grid">
        <div class="g4">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</label>
          <select id="sellProduct"></select>
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="sellQty" type="number" step="1" min="1" value="1" />
          <label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label><input id="sellPrice" type="number" step="0.01" />
          <div class="grid">
            <div class="g6">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬</label>
              <select id="lineDiscType">
                <option value="none">Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…</option>
                <option value="amount">Ø®ØµÙ… Ù…Ø¨Ù„Øº</option>
                <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø© %</option>
              </select>
            </div>
            <div class="g6">
              <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label>
              <input id="lineDiscVal" type="number" step="0.01" value="0" />
            </div>
          </div>
          <label>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="deliveryFee" type="number" step="0.01" value="0" />
          <button class="btn-primary" id="addLine" type="button">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨</button>
          <label style="margin-top:12px">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</label><input id="orderDate" type="date" />
          <button class="btn-primary" id="saveOrder" type="button" style="margin-top:8px">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
        <div class="g8">
          <div class="flex"><h3 style="margin:0">Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</h3><div class="right"><button id="exportCart" type="button" class="btn-muted" data-export="1" data-table="cartTable" data-filename="cart.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
          <table id="cartTable">
            <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th colspan="4" style="text-align:left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</th><th id="orderTotalCell">0.00</th><th></th></tr></tfoot>
          </table>

          <div class="flex" style="margin-top:18px"><h3 style="margin:0">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3><div class="right">
            <button id="exportOrders" type="button" class="btn-muted" data-export="1" data-table="ordersTable" data-filename="orders.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button>
          </div></div>
          <table id="ordersTable">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
    <section class="panel" data-tab="dashboard" hidden>
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</h2>
      
      <!-- ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
      <div class="grid" style="margin-bottom: 16px;">
        <div class="g6">
          <label>ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
          <div class="flex" style="gap: 8px;">
            <button type="button" class="tab" id="periodToday" data-period="today">Ø§Ù„ÙŠÙˆÙ…</button>
            <button type="button" class="tab" id="periodWeek" data-period="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
            <button type="button" class="tab" id="periodMonth" data-period="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
            <button type="button" class="tab" id="periodCustom" data-period="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</button>
          </div>
        </div>
        <div class="g6" id="customDateRange" hidden>
          <div class="flex" style="gap: 8px;">
            <div>
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="customStartDate" />
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="customEndDate" />
            </div>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div class="kpis" id="dashboardKpis"></div>

      <!-- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
      <div class="grid" style="margin: 16px 0;">
        <div class="g6">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <select id="chartDataset">
            <option value="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
            <option value="purchases">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
            <option value="profit">Ø§Ù„Ø±Ø¨Ø­</option>
          </select>
        </div>
        <div class="g6">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</label>
          <select id="chartType">
            <option value="line">Ø®Ø·ÙŠ</option>
            <option value="bar">Ø£Ø¹Ù…Ø¯Ø©</option>
            <option value="pie">Ø¯Ø§Ø¦Ø±ÙŠ</option>
          </select>
        </div>
      </div>

      <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
      <div style="background: #0b1224; border: 1px solid #1f2a44; border-radius: 14px; padding: 14px; margin: 16px 0;">
        <canvas id="dashboardChart" width="800" height="400" style="width: 100%; height: 300px; max-width: 800px;"></canvas>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
      <div class="flex" style="margin-top: 18px;">
        <h3 style="margin: 0">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
        <div class="right">
          <button id="exportDashboardSummary" type="button" class="btn-muted" data-export="1" data-table="dashboardSummaryTable" data-filename="dashboard-summary.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button>
        </div>
      </div>
      <table id="dashboardSummaryTable">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
            <th>Ø§Ù„Ø±Ø¨Ø­</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ØªÙ‚Ø§Ø±ÙŠØ± -->
    <section class="panel" data-tab="reports" hidden>
      <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
      <div class="kpis" id="kpis"></div>
      <div class="flex"><h3 style="margin:0">Ø£Ø¯Ù†Ù‰ Ù…Ø®Ø²ÙˆÙ†</h3><div class="right"><button id="exportLowStock" type="button" class="btn-muted" data-export="1" data-table="lowStockTable" data-filename="low-stock.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
      <table id="lowStockTable">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="flex" style="margin-top:18px"><h3 style="margin:0">Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ù‹Ø§</h3><div class="right"><button id="exportTopProducts" type="button" class="btn-muted" data-export="1" data-table="topProductsTable" data-filename="top-products.csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± (Excel)</button></div></div>
      <table id="topProductsTable">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <section class="panel" data-tab="settings" hidden>
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div class="grid">
        <div class="g6">
          <label>Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù„ÙƒÙ„ Ù…Ù†ØªØ¬)</label>
          <input id="lowStockThreshold" type="number" min="0" step="1" />
          <button class="btn-primary" id="saveSettings" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <div class="hint">ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ "Ù…Ù†Ø®ÙØ¶" Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚Ù„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯.</div>
        </div>
        <div class="g6">
          <h3 style="margin-top:0">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><input id="curPass" type="password" />
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input id="newPass" type="password" />
          <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input id="newPass2" type="password" />
          <button class="btn-primary" id="btnChangePass" type="button">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
          <div class="hint">ØªÙØ®Ø²Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…ÙØ´ÙÙ‘Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ.</div>
        </div>
      </div>
    
      <!-- LILIJA:BEGIN USERS_ADMIN -->
<div id="usersAdminSection">
        <hr style="border-color:#1f2a44;margin:18px 0" />
        <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
        <div id="usersAdminWrap"></div>
      </div>
<!-- LILIJA:END USERS_ADMIN -->
</section>
<!-- LILIJA:BEGIN AUDIT_LOG -->
<section class="panel" data-tab="audit" hidden>
  <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
  <div class="hint">ÙŠØ³Ø¬Ù‘Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª/Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙˆÙ‚Øª.</div>
  <div class="flex" style="gap:8px;margin:8px 0">
    <input id="auditSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." />
    <button id="btnAuditExport" type="button">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
    <button id="btnAuditClear" class="btn-danger" type="button">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
  </div>
  <div class="table-wrap">
    <table id="auditTable">
      <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</th><th>Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- LILIJA:END AUDIT_LOG -->

  

  </main>

  <script>
  
  // ====== Users Admin (inside Settings) ======
  function renderUsersAdmin(){
    ensureUserSchema();
    const section = document.getElementById('usersAdminSection');
    const wrap = document.getElementById('usersAdminWrap');
    if(!section || !wrap) return;
    const me = currentUser(); const isAdmin = me && (me.type==='admin' || me.isRoot===true);
    section.style.display = isAdmin ? '' : 'none';
    if(!isAdmin){ wrap.innerHTML=''; return; }

    const users = loadUsers();
    const isRoot = me && me.isRoot === true;
    const canCreate = isRoot && users.length < 5;

    let htmlUI = '<div class="hint">'+(isRoot?'Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.':'Ø¹Ø±Ø¶ ÙÙ‚Ø·')+'</div>';
    if(isRoot){
      htmlUI += '<div class="flex" style="gap:8px;margin:8px 0"><button id="btnCreateUser" class="btn-primary" type="button">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button><span class="hint">(' + users.length + '/5)</span></div>';
    }
    htmlUI += '<div class="table-wrap"><table><thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</th><th>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</th><th>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</th><th></th></tr></thead><tbody>';

    function permCells(u, mod){
      const p=(u.perms&&u.perms[mod])||{};
      function cb(act, lbl){
        const checked = (u.type==='admin') ? 'checked disabled' : (p[act]?'checked':'');
        return '<label class="hint" style="display:inline-flex;gap:4px;align-items:center;margin:0 6px"><input data-uid="'+u.username+'" data-mod="'+mod+'" data-act="'+act+'" type="checkbox" '+checked+' /><span>'+lbl+'</span></label>';
      }
      return u.isRoot ? 'â€”' : cb('view','Ø±Ø¤ÙŠØ©') + cb('edit','ØªØ¹Ø¯ÙŠÙ„') + cb('delete','Ø­Ø°Ù');
    }

    users.forEach(u=>{
      htmlUI += '<tr><td>'+u.username+'</td><td>'+(u.isRoot? '<span class="hint">Ø£Ø¯Ù…Ù† Ø±Ø¦ÙŠØ³ÙŠ</span>' : `<select data-role="${u.username}"><option value="user" ${u.type==='user'?'selected':''}>User</option><option value="admin" ${u.type==='admin'?'selected':''}>Admin</option></select>` )+'</td>'
      + '<td>'+permCells(u,'products')+'</td>'
      + '<td>'+permCells(u,'sales')+'</td>'
      + '<td>'+permCells(u,'purchases')+'</td>'
      + '<td>'+permCells(u,'users')+'</td>'
      + '<td>'+permCells(u,'settings')+'</td>'
      + '<td>'+permCells(u,'audit')+'</td>'
      + '<td>'+(u.isRoot ? '' : `<button class="btn-danger" data-remove="${u.username}" type="button">Ø­Ø°Ù</button>` )+'</td></tr>';
    });

    htmlUI += '</tbody></table></div>';
    wrap.innerHTML = htmlUI;

    wrap.onchange = (e)=>{
      const uname = e.target.getAttribute('data-role');
      if(uname){
        const list = loadUsers(); const u = list.find(x=>x.username===uname); if(!u) return;
        if(u.isRoot) { e.target.value = 'admin'; return; }
        const nextType = e.target.value;
        const adminCount = list.filter(x => x.type==='admin' || x.isRoot===true).length;
        if(u.type==='admin' && nextType!=='admin' && adminCount<=1){
          alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); e.target.value = 'admin'; return;
        }
        u.type = nextType; saveUsers(list); return;
      }
      const uid = e.target.getAttribute('data-uid');
      if(uid){
        const mod = e.target.getAttribute('data-mod');
        const act = e.target.getAttribute('data-act');
        const list = loadUsers(); const u = list.find(x=>x.username===uid); if(!u) return;
        if(u.isRoot) return;
        u.perms = u.perms || {}; u.perms[mod] = u.perms[mod] || {view:false,edit:false,delete:false};
        u.perms[mod][act] = e.target.checked; saveUsers(list); return;
      }
    };
    wrap.onclick = (e)=>{
      const rm = e.target.getAttribute('data-remove');
      if(rm){
        if(rm===currentUser) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ');
        const list = loadUsers(); const u = list.find(x=>x.username===rm); if(u?.isRoot) return;
        const next = list.filter(x=>x.username!==rm);
        const adminCount = next.filter(x => x.type==='admin' || x.isRoot===true).length;
        if(adminCount===0) return alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        saveUsers(next); renderUsersAdmin(); return;
      }
    };

    const btn = document.getElementById('btnCreateUser');
    if(btn){
      btn.disabled = !canCreate;
      btn.onclick = async ()=>{
        if(!canCreate) return;
        const uname = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ'); if(!uname) return;
        const pass1 = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ'); if(!pass1) return;
        const list = loadUsers();
        if(list.length>=5) return alert('Ø¨Ù„ØºØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
        if(list.find(x=>x.username.toLowerCase()===uname.toLowerCase())) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯');
        const salt = genSalt(); const hash = await sha256(pass1 + salt);
        const defaultPermsUser = Object.fromEntries(LilijaAuth.MODULES.map(m=>[m,{view:true,edit:false,delete:false}]));
        list.push({ username:uname, salt, hash, type:'user', perms: defaultPermsUser });
        saveUsers(list); renderUsersAdmin();
      };
    }
  }

  // ====== (replaced) ======
  //(function(){
  //  const body = document.body;
  //  if(!body.__lilijaProductsBound){
   //   body.__lilijaProductsBound = true;
    //  body.addEventListener('click', (ev)=>{
      //  const addBtn = ev.target.closest('#addProduct');
        //if(addBtn){
        //  try{
         //   const pName = document.getElementById('pName');
          //  const pSku  = document.getElementById('pSku');
         //   const pCat  = document.getElementById('pCat');
          //  const pPrice= document.getElementById('pPrice');
           // const name = (pName?.value||'').trim();
          //  if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
           // const _id = uid();
            //db.products.push({ id:_id, name, sku:(pSku?.value||'').trim(), cat:(pCat?.value||'').trim(), price:Number(pPrice?.value)||0 });
            //try{ recordAudit('add','products', _id, name, 0); }catch(e){}
           // saveDB(db);
           // if(pName) pName.value=''; if(pSku) pSku.value=''; if(pCat) pCat.value=''; if(pPrice) pPrice.value='';
           // refreshAll();
          //}catch(e){ console.warn('addProduct (delegate) failed', e); }
         // return;
       // }
       // const delBtn = ev.target.closest('#productsTable [data-del]');
        //if(delBtn){
         // try{
          //  const id = delBtn.getAttribute('data-del');
           // if(!id) return;
           // if(!softConfirm(delBtn)) return;
           // const px = db.products.find(x=>x.id===id);
            //try{ recordAudit('delete','products', id, px?px.name:''); }catch(e){}
            //db.products = db.products.filter(x=>x.id!==id);
           // saveDB(db); refreshAll();
          //}catch(e){ console.warn('delete product (delegate) failed', e); }
          //return;
       // }
     // }, true);
    //}
  //})();

  // ====== Robust click bindings (products add/delete) v2 ======
// Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ (PO)
function ensureCounters(){
  db.counters = db.counters || {};
  if (typeof db.counters.nextPo !== 'number') db.counters.nextPo = 1001; // Ø§Ø¨Ø¯Ø£ Ù…Ù† 1001 Ù…Ø«Ù„Ø§Ù‹
}
function nextPo(){
  ensureCounters();
  const n = db.counters.nextPo;
  db.counters.nextPo++;
  if (typeof saveDB === 'function') saveDB(db);
  return n;
}
// ====== Auth & DB Keys ======
  const USERS_KEY = 'miniStoreUsers_v1';
  const SESSION_KEY = 'miniStoreSession_v1';
  let currentUser = null;
  let dbKeyBase = 'miniStoreDB_v3_orders';
  let dbKey = dbKeyBase;

  // ====== Crypto helpers ======
  const enc = new TextEncoder();
  async function sha256(text){ const buf = await crypto.subtle.digest('SHA-256', enc.encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function genSalt(){ return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2); }

  function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)) || []; }catch{ return []; } }
  function saveUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
  function setSession(username){ sessionStorage.setItem(SESSION_KEY, JSON.stringify({username})); }
  function getSession(){ try{ return JSON.parse(sessionStorage.getItem(SESSION_KEY)); }catch{ return null; } }
  function clearSession(){ sessionStorage.removeItem(SESSION_KEY); }

  // ====== Data Layer ======
  const nowISO = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(36).slice(2,9);
  const deepClone = (o)=> JSON.parse(JSON.stringify(o));
  const defaults = { products: [], purchases: [], sales: [], settings: { lowStockThreshold: 5 }, audit: [] };
  function loadDB(){ try{ return JSON.parse(localStorage.getItem(dbKey)) || deepClone(defaults);}catch{ return deepClone(defaults); } }
  function saveDB(db){ localStorage.setItem(dbKey, JSON.stringify(db)); }
  
  let db = null;
  
  // ====== Light App namespace to reduce global pollution ======
  window.App = {
    db: null,
    setDB: function(newDb) { 
      this.db = newDb; 
      window.db = newDb; // Keep legacy global for compatibility
    },
    getDB: function() { return this.db || window.db; },
    getCurrentUser: () => window.getCurrentUser ? getCurrentUser() : null,
    utils: window.LilijaUtils,
    auth: window.LilijaAuth, 
    data: window.LilijaData
  };
  
  window.db = db;

  // ====== Helpers ======
  // Note: productMap, sum, calcStats moved to modules/utils.js and modules/data.js

  // ====== UI Tabs ======
  const tabsCfg = [
    {id:'products', label:'ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª'},
    {id:'purchases', label:'â¬…ï¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª'},
    {id:'sales', label:'â¡ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø·Ù„Ø¨Ø§Øª)'},
    {id:'dashboard', label:'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶'},
    {id:'reports', label:'ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
    {id:'settings', label:'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'},
    {id:'audit', label:'ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª'},
  ];
  
  // Note: Auth & permissions moved to modules/auth.js

  const tabsEl = document.getElementById('tabs');
  tabsCfg.forEach(t=>{ const b = document.createElement('button'); b.className='tab'; b.textContent=t.label; b.dataset.tab=t.id; tabsEl.appendChild(b); });
  function activateTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    document.querySelectorAll('section.panel').forEach(s=>{ 
      s.hidden = s.dataset.tab!==id; 
      if(id==='settings' && typeof renderUsersAdmin==='function') renderUsersAdmin(); 
      if(id==='audit' && typeof renderAudit==='function') renderAudit();
      if(id==='dashboard' && typeof renderDashboard==='function') renderDashboard();
    });
    localStorage.setItem(dbKey+':tab', id);
    refreshAll();
  }
  tabsEl.addEventListener('click', (e)=>{ if(e.target.classList.contains('tab')) activateTab(e.target.dataset.tab); });
  function getLastTab(){ return localStorage.getItem(dbKey+':tab') || 'products'; }

  // ====== Products ======
  const pName = document.getElementById('pName');
  const pSku = document.getElementById('pSku');
  const pCat = document.getElementById('pCat');
  const pPrice = document.getElementById('pPrice');
  document.getElementById('addProduct').onclick = () => {
  // Ù‚Ø±Ø§Ø¡Ø§Øª ÙˆØ­Ø³Ø§Ø¨Ø§Øª Ø£ÙˆÙ„ÙŠØ©
  const nameRaw = pName.value || '';
  const skuRaw  = pSku.value || '';
  const catRaw  = pCat.value || '';
  const priceRaw = Number(pPrice.value) || 0;

  const name = nameRaw.trim();
  const sku  = skuRaw.trim();
  const cat  = catRaw.trim();

  if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'); pName.focus(); return; }

  // Check for duplicates using shared utilities
  if (isDuplicateProductName(name)) {
    alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
    pName.focus();
    return;
  }

  if (isDuplicateSKU(sku)) {
    alert('Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯/â€SKU Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§');
    pSku.focus();
    return;
  }

  // Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const _id = uid();
  db.products.push({ id:_id, name, sku, cat, price: priceRaw });
  try { recordAudit && recordAudit('add','products', _id, name, 0); } catch(_) {}
  saveDB(db);

  // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
  pName.value = pSku.value = pCat.value = '';
  pPrice.value = '';

  refreshAll();
};

 function renderProducts() {
  const tbody = document.querySelector('#productsTable tbody');
  if (!tbody) return;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
  tbody.innerHTML = '';
  const stats = calcStats();
  const mapStat = new Map(stats.map(s => [s.id, s]));

  for (const p of db.products) {
    const s = mapStat.get(p.id) || { stock: 0 };
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.sku || ''}</td>
      <td>${p.cat || ''}</td>
      <td>${(p.price || 0).toFixed(2)}</td>
      <td>${s.stock || 0}</td>
      <td class="flex">
        <button data-edit="${p.id}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
        <button data-del="${p.id}" class="btn-danger" type="button">Ø­Ø°Ù</button>
      </td>`;
    tbody.appendChild(tr);
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± (ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)
  tbody.onclick = async (e) => {
    const btnEdit = e.target.closest('button[data-edit]');
    const btnDel  = e.target.closest('button[data-del]');
    if (!btnEdit && !btnDel) return;

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    if (btnEdit) {
      const id = btnEdit.dataset.edit;
      const p = db.products.find(x => x.id === id);
      if (!p) return;

      const name  = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', p.name);    if (name  === null) return;
      const sku   = prompt('SKU',        p.sku || ''); if (sku   === null) return;
      const cat   = prompt('Ø§Ù„ÙØ¦Ø©',      p.cat || ''); if (cat   === null) return;
      const price = parseFloat(prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹', p.price || 0));
      if (Number.isNaN(price)) return;

      // Check for duplicates using shared utilities (excluding current product)
      if (isDuplicateProductName(name, p.id)) {
        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
        return;
      }

      if (isDuplicateSKU(sku, p.id)) {
        alert('Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯/â€SKU Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§');
        return;
      }

Object.assign(p, { name, sku, cat, price });
try { recordAudit && recordAudit('edit','products', p.id, `name=${name},sku=${sku},price=${price}`); } catch(_){}
saveDB(db); 
refreshAll();
      return;
    }

    // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯)
    if (btnDel) {
      const idDel = btnDel.dataset.del;
      const px = db.products.find(x => x.id === idDel);
      const res = await confirmDeleteUniversal('products', idDel, px ? px.name : '');
      if (!res.ok) return;

      db.products = db.products.filter(x => x.id !== idDel);
      saveDB(db);
      refreshAll();
      return;
    }
  };
}


  // ====== Purchases ======
  const buyProduct = document.getElementById('buyProduct');
  const buyQty = document.getElementById('buyQty');
  const buyCost = document.getElementById('buyCost');
  const buyDate = document.getElementById('buyDate'); if(buyDate) buyDate.value = nowISO();
//  document.getElementById('addPurchase').onclick = ()=>{
//    const pid = buyProduct.value; if(!pid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
//    const qty = Number(buyQty.value); const cost = Number(buyCost.value);
//    if(!(qty>0 && cost>=0)) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ÙˆØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­Ø©');
//    const _pid=uid(); db.purchases.push({ id:_pid, productId:pid, qty, unitCost:cost, date: buyDate.value || nowISO() });
//    try{ const pn=(db.products.find(x=>x.id===pid)?.name)||''; recordAudit('add','purchases', _pid, pn, qty);}catch{}
//    saveDB(db); buyQty.value=''; buyCost.value=''; refreshAll();
//  };
// Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¶Ø¹ Ø§Ù„Ø¯Ø§Ù„ØªÙŠÙ† global Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
//function ensureCounters() {
//  db.counters = db.counters || {};
//  if (typeof db.counters.nextPo !== 'number') db.counters.nextPo = 1001; // Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ù€Ø©
//}
//function nextPo() {
//  ensureCounters();
//  const n = db.counters.nextPo;
//  db.counters.nextPo++;
//  if (typeof saveDB === 'function') saveDB(db);
//  return n;/
//}

function renderPurchases() {
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if (!buyProduct) return;

  // 1) ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  buyProduct.innerHTML =
    '<option value="">â€” Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ â€”</option>' +
    db.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

  // 2) Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯ÙŠÙ† + Ø¨Ø§Ø¯Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: Ù†Ù†Ø´Ø¦Ù‡Ø§ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡
  // 2) Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯ÙŠÙ† + Ø¨Ø§Ø¯Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: Ø¯Ø§Ø®Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© (poDraftBox)
ensureCounters();
const poBox = document.getElementById('poDraftBox');
if (poBox && !document.getElementById('supName')) {
  poBox.insertAdjacentHTML('afterbegin', `
    <div id="supFields" class="flex" style="gap:8px;margin-bottom:8px;align-items:center">
      <span id="poPreview" class="tag" title="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¯Ù…">#${db.counters?.nextPo ?? 1001}</span>
      <input id="supName"  placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
      <input id="supPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
    </div>
  `);
}
const poPreview = document.getElementById('poPreview');
if (poPreview) poPreview.textContent = '#' + (db.counters?.nextPo ?? 1001);
  const supName   = document.getElementById('supName');
  const supPhone  = document.getElementById('supPhone');
  const poPreview = document.getElementById('poPreview');
  if (poPreview) poPreview.textContent = '#' + (db.counters?.nextPo ?? 1001);
  // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
if (controls && !document.getElementById('poDraftBox')){
  controls.insertAdjacentHTML('beforeend', `
    <div id="poDraftBox" class="panel" style="margin-top:10px">
      <div class="flex">
        <strong>Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</strong>
        <span class="tag" style="margin-inline-start:auto">PO Ø§Ù„Ù‚Ø§Ø¯Ù…: <span id="poPreview2">#${db.counters?.nextPo ?? 1001}</span></span>
      </div>
      <div class="flex" style="gap:8px;margin:8px 0">
        <button id="savePO" class="btn-primary" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        <button id="printDraft" class="btn-muted" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
        <button id="clearDraft" class="btn-danger" type="button">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
      </div>
      <table id="poDraftTable">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th id="poDraftTotal">0.00</th><th></th></tr></tfoot>
      </table>
    </div>
  `);
}
const poPrev2 = document.getElementById('poPreview2');
if (poPrev2) poPrev2.textContent = '#' + (db.counters?.nextPo ?? 1001);

// Ø£ÙˆÙ„ Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
renderPurchaseDraft();

  // 3) Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶
  const tbody = document.querySelector('#purchasesTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const pmap = productMap();
  for (const r of db.purchases) {
    const tr = document.createElement('tr');
    const total = (Number(r.qty) || 0) * (Number(r.unitCost) || 0);
    tr.innerHTML = `
      <td>${r.date || ''}</td>
      <td>${pmap.get(r.productId)?.name || 'â€”'}</td>
      <td>${r.qty}</td>
      <td>${(r.unitCost || 0).toFixed(2)}</td>
      <td>${total.toFixed(2)}</td>
      <td>${r.supplier || ''}</td>
      <td>${r.supplierPhone || ''}</td>
      <td>${r.po ? ('#' + r.po) : ''}</td>
      <td><button data-del="${r.id}" class="btn-danger" type="button">Ø­Ø°Ù</button></td>
    `;
    tbody.appendChild(tr);
  }

  // 4) Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡: Ù†Ø±Ø¨Ø·Ù‡ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆÙ†Ø¶ÙŠÙ supplier + po
// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙÙˆØ±ÙŠ
const addBtn = document.getElementById('addPurchase');
if (addBtn && !addBtn.__boundDraft){
  addBtn.__boundDraft = true;
  addBtn.onclick = () => {
    const prodId = buyProduct.value;
    const qty  = Number(buyQty?.value)||0;
    const cost = Number(buyCost?.value)||0;
    if(!prodId) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
    if(qty<=0)  return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©');
    if(cost<0)  return alert('Ø£Ø¯Ø®Ù„ ØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­Ø©');

    purchaseDraft.push({ productId: prodId, qty, unitCost: cost });
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ÙŠØ©
    if(buyQty)  buyQty.value = '';
    if(buyCost) buyCost.value = '';
    if(buyProduct) buyProduct.value = '';
    renderPurchaseDraft();
  };
}
   // Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù†Ø´Ø§Ø¡ PO ÙˆØ§Ø­Ø¯ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³ÙˆØ¯Ø©)
  // Ø¯Ø§Ø®Ù„ btnSavePO.onclick ÙˆØ¨Ø¹Ø¯ renderPurchaseDraft() Ùˆ refreshAll()
const supNameEl  = document.getElementById('supName');
const supPhoneEl = document.getElementById('supPhone');
if (supNameEl)  supNameEl.value  = '';
if (supPhoneEl) supPhoneEl.value = '';
const btnSavePO = document.getElementById('savePO');
if (btnSavePO && !btnSavePO.__bound){
  btnSavePO.__bound = true;
  btnSavePO.onclick = ()=>{
    if(purchaseDraft.length===0) return alert('Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙØ§Ø±ØºØ©');

    const supplier      = (document.getElementById('supName')?.value||'').trim();
    const supplierPhone = (document.getElementById('supPhone')?.value||'').trim();
    const dateStr = (document.getElementById('buyDate')?.value) || (new Date().toISOString().slice(0,10));
    const po = nextPo();

    const pmap = productMap();
    purchaseDraft.forEach(it=>{
      const id = uid();
      db.purchases.push({
        id, po,
        productId: it.productId,
        qty: it.qty,
        unitCost: it.unitCost,
        date: dateStr,
        supplier, supplierPhone
      });
      try{
        const pn = pmap.get(it.productId)?.name || '';
        recordAudit && recordAudit('add','purchases', id, `PO#${po} | ${pn} Ã—${it.qty}`, it.qty);
      }catch(_){}
    });

    saveDB(db);
    purchaseDraft = [];
    const poPrev = document.getElementById('poPreview'); if(poPrev) poPrev.textContent = '#' + (db.counters?.nextPo ?? 1001);
    const poPrev2= document.getElementById('poPreview2'); if(poPrev2) poPrev2.textContent= '#' + (db.counters?.nextPo ?? 1001);
    renderPurchaseDraft();
    refreshAll();
    // Ø¯Ø§Ø®Ù„ btnClear.onclick Ø¨Ø¹Ø¯ ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
const supNameEl  = document.getElementById('supName');
const supPhoneEl = document.getElementById('supPhone');
if (supNameEl)  supNameEl.value  = '';
if (supPhoneEl) supPhoneEl.value = '';
    if(confirm('ØªÙ… Ø§Ù„Ø­ÙØ¸. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¢Ù†ØŸ')){
      printPurchaseByPO(po);
    }
  };
}

const btnClear = document.getElementById('clearDraft');
if (btnClear && !btnClear.__bound){
  btnClear.__bound = true;
  btnClear.onclick = ()=>{
    if(!confirm('Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©ØŸ')) return;
    purchaseDraft = []; renderPurchaseDraft();
  };
}

const btnPrintDraft = document.getElementById('printDraft');
if (btnPrintDraft && !btnPrintDraft.__bound){
  btnPrintDraft.__bound = true;
  btnPrintDraft.onclick = ()=> printPurchaseDraft();
}


  // 5) Ø­Ø°Ù Ø´Ø±Ø§Ø¡ (ÙƒÙ…Ø§ Ø¹Ù…Ù„ØªÙ Ø³Ø§Ø¨Ù‚Ù‹Ø§)
  tbody.onclick = async (e) => {
    if (e.target.dataset.del) {
      const id = e.target.dataset.del;
      const rec = db.purchases.find(x => x.id === id);
      const pn = (db.products.find(x => x.id === rec.productId)?.name) || '';
      const res = await confirmDeleteUniversal('purchases', id, pn, rec.qty);
      if (!res.ok) return;
      db.purchases = db.purchases.filter(x => x.id !== id);
      saveDB(db); refreshAll();
      // Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨Ø¹Ø¯ increment nextPo + refreshAll()
const poPrev = document.getElementById('poPreview');
if (poPrev) poPrev.textContent = '#' + (db.counters?.nextPo ?? 1001);
      return;
    }
  };
}
    
// Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (PO draft)
let purchaseDraft = []; // [{productId, qty, unitCost}...]

function renderPurchaseDraft(){
  const box = document.getElementById('poDraftBox');
  if(!box) return;
  const table = document.getElementById('poDraftTable');
  if(!table) return;

  const pmap = productMap();
  const tbody = table.tBodies[0];
  tbody.innerHTML = '';

  let sum = 0;
  purchaseDraft.forEach((it, idx)=>{
    const name = pmap.get(it.productId)?.name || 'â€”';
    const lineTotal = (Number(it.qty)||0) * (Number(it.unitCost)||0);
    sum += lineTotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${it.qty}</td><td>${(Number(it.unitCost)||0).toFixed(2)}</td><td>${lineTotal.toFixed(2)}</td>
      <td><button data-rm="${idx}" class="btn-danger" type="button">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });

  const tfoot = table.tFoot;
  if(tfoot){
    const cell = tfoot.querySelector('th#poDraftTotal');
    if(cell) cell.textContent = sum.toFixed(2);
  }

  tbody.onclick = (e)=>{
    const i = e.target.dataset.rm;
    if(i===undefined) return;
    if(!softConfirm(e.target)) return;
    purchaseDraft.splice(Number(i),1);
    renderPurchaseDraft();
  };
}

function printPurchaseDraft(){
  if(purchaseDraft.length===0) return alert('Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙØ§Ø±ØºØ©');
  const sup = (document.getElementById('supName')?.value||'').trim();
  const tel = (document.getElementById('supPhone')?.value||'').trim();
  const pmap = productMap();
  let rows = '';
  let sub = 0;
  purchaseDraft.forEach(it=>{
    const name = pmap.get(it.productId)?.name || 'â€”';
    const line = (Number(it.qty)||0) * (Number(it.unitCost)||0);
    sub += line;
    rows += `<tr><td>${name}</td><td>${it.qty}</td><td>${(Number(it.unitCost)||0).toFixed(2)}</td><td>${line.toFixed(2)}</td></tr>`;
  });
  const w = window.open('', '_blank');
  w.document.write(`
    <html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ù…Ø³ÙˆØ¯Ø© PO</title>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px;text-align:right}</style>
    </head><body>
      <h2>Ù…Ø³ÙˆØ¯Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
      <div>Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯: ${sup||'-'} &nbsp; | &nbsp; Ù‡Ø§ØªÙ: ${tel||'-'}</div>
      <hr>
      <table><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${sub.toFixed(2)}</th></tr></tfoot>
      </table>
      <div style="margin-top:12px"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
    </body></html>`);
  w.document.close();
}

function printPurchaseByPO(po){
  const list = (db.purchases||[]).filter(r=>r.po === po);
  if(list.length===0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
  const pmap = productMap();
  let rows = ''; let sub = 0; let sup=''; let tel='';
  list.forEach(r=>{
    const name = pmap.get(r.productId)?.name || 'â€”';
    const line = (Number(r.qty)||0)*(Number(r.unitCost)||0);
    sub += line; rows += `<tr><td>${name}</td><td>${r.qty}</td><td>${(Number(r.unitCost)||0).toFixed(2)}</td><td>${line.toFixed(2)}</td></tr>`;
    sup = r.supplier || sup; tel = r.supplierPhone || tel;
  });
  const w = window.open('', '_blank');
  w.document.write(`
    <html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>PO #${po}</title>
    <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px;text-align:right}</style>
    </head><body>
      <h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª #${po}</h2>
      <div>Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯: ${sup||'-'} &nbsp; | &nbsp; Ù‡Ø§ØªÙ: ${tel||'-'}</div>
      <hr>
      <table><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${sub.toFixed(2)}</th></tr></tfoot>
      </table>
      <div style="margin-top:12px"><button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button></div>
    </body></html>`);
  w.document.close();
}


  // ====== Sales ======
  let currentOrder = { items: [] };
  const sellProduct = document.getElementById('sellProduct');
  const sellQty = document.getElementById('sellQty');
  const sellPrice = document.getElementById('sellPrice');
  const lineDiscType = document.getElementById('lineDiscType');
  const lineDiscVal = document.getElementById('lineDiscVal');
  const orderDate = document.getElementById('orderDate'); if(orderDate) orderDate.value = nowISO();
  const deliveryFee = document.getElementById('deliveryFee');
  const cartTableBody = ()=> document.querySelector('#cartTable tbody');
  const orderTotalCell = document.getElementById('orderTotalCell');

  function getProductPrice(pid){ return (db.products.find(p=>p.id===pid)?.price)||0; }
  function lineTotal(qty, unitPrice, discType, discValue){
    qty = Number(qty)||0; unitPrice = Number(unitPrice)||0; discValue = Number(discValue)||0;
    let gross = qty*unitPrice; let disc = 0;
    if(discType==='amount') disc = discValue; else if(discType==='percent') disc = gross*(discValue/100);
    return Math.max(0, gross - disc);
  }

  function renderCart(){
    const tbody = cartTableBody(); if(!tbody) return; tbody.innerHTML='';
    let total = 0; const pmap = productMap();
    currentOrder.items.forEach((it, idx)=>{
      const lt = lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue); total += lt;
      const tr = document.createElement('tr');
      const discLabel = it.discountType==='amount' ? `${(Number(it.discountValue)||0).toFixed(2)} AED` : (it.discountType==='percent'? `${(Number(it.discountValue)||0).toFixed(2)}%` : 'â€”');
      tr.innerHTML = `<td>${pmap.get(it.productId)?.name||'â€”'}</td><td>${it.qty}</td><td>${(Number(it.unitPrice)||0).toFixed(2)}</td><td>${discLabel}</td><td>${lt.toFixed(2)}</td>
      <td><button data-del-line="${idx}" class="btn-danger" type="button">Ø­Ø°Ù</button></td>`;
      tbody.appendChild(tr);
    });
    const del = Number(deliveryFee?.value)||0;
    if(orderTotalCell) orderTotalCell.textContent = (total + del).toFixed(2);
    tbody.onclick = (e)=>{ const i = e.target.dataset.delLine; if(i===undefined) return; if(!softConfirm(e.target)) return; currentOrder.items.splice(Number(i),1); renderCart(); };
  }

  document.getElementById('addLine').onclick = ()=>{
    const pid = sellProduct.value; if(!pid) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬');
    const qty = Number(sellQty.value)||0; if(qty<=0) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
    const up = Number(sellPrice.value)||0; if(up<0) return alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­');
    currentOrder.items.push({ productId: pid, qty, unitPrice: up, discountType: lineDiscType.value, discountValue: Number(lineDiscVal.value)||0 });
    renderCart();
  };

  document.getElementById('saveOrder').onclick = ()=>{
    if(currentOrder.items.length===0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
    const stats = calcStats();
    for(const it of currentOrder.items){
      const s = stats.find(x=>x.id===it.productId); if(s && s.stock < it.qty){
        if(!confirm('Ù‡Ù†Ø§Ùƒ ØµÙ†Ù ÙƒÙ…ÙŠØªÙ‡ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
        break;
      }
    }
    const delFee = Number(deliveryFee?.value)||0;
    const _oid = uid(); db.sales.push({ id: _oid, date: (orderDate && orderDate.value) || nowISO(), items: deepClone(currentOrder.items), deliveryFee: delFee });
    try{ recordAudit('add','sales', _oid, 'order', currentOrder.items.length);}catch{} saveDB(db); currentOrder.items = []; renderSales(); renderReports();
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨');
  };

  function renderOrdersList(){
    const tbody = document.querySelector('#ordersTable tbody'); if(!tbody) return; tbody.innerHTML='';
    for(const o of db.sales){
      const itemCount = Array.isArray(o.items)? o.items.length : 1;
      let total=0;
      if(Array.isArray(o.items)){
        for(const it of o.items){ total += lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue); }
      } else { total = (Number(o.qty)||0)*(Number(o.unitPrice)||0); }
      total += Number(o.deliveryFee||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.date||''}</td><td>${itemCount}</td><td>${total.toFixed(2)}</td>
      <td class="flex"><button data-inv="${o.id}" type="button">ÙØ§ØªÙˆØ±Ø©</button><button data-del-order="${o.id}" class="btn-danger" type="button">Ø­Ø°Ù</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.onclick = async (e)=>{
  const idDel = e.target.dataset.delOrder;
  const idInv = e.target.dataset.inv;

  if (idDel) {
    const res = await confirmDeleteUniversal('sales', idDel, 'order');
    if (!res.ok) return;
    db.sales = db.sales.filter(x => x.id !== idDel);
    saveDB(db); renderSales(); renderReports();
    return;
  }

  if (idInv) { openInvoice(idInv); return; }
};
  }

  function renderSales(){
    if(sellProduct){
      sellProduct.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ â€”</option>' + db.products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      sellProduct.onchange = ()=>{ sellPrice.value = getProductPrice(sellProduct.value).toFixed(2); };
      sellPrice.value = sellProduct.value ? getProductPrice(sellProduct.value).toFixed(2) : '';
    }
    renderCart();
    renderOrdersList();
  }

  // ====== Invoice ======
  function fmt(n){ return (Number(n)||0).toFixed(2); }
  function openInvoice(orderId){
    const o = db.sales.find(x=>x.id===orderId); if(!o) return alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const pmap = productMap();
    let sub=0;
    const rows = (o.items||[]).map(it=>{
      const name = pmap.get(it.productId)?.name || 'â€”';
      const lt = lineTotal(it.qty, it.unitPrice, it.discountType, it.discountValue);
      sub += lt;
      const discLabel = it.discountType==='amount' ? `${fmt(it.discountValue)} AED` :
                        (it.discountType==='percent' ? `${fmt(it.discountValue)}%` : 'â€”');
      return `<tr><td>${name}</td><td>${it.qty}</td><td>${fmt(it.unitPrice)}</td><td>${discLabel}</td><td>${fmt(lt)}</td></tr>`;
    }).join('');
    const del = Number(o.deliveryFee||0);
    const total = sub + del;
    const win = window.open('', '_blank');
    win.document.write(`
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8" />
        <title>ÙØ§ØªÙˆØ±Ø©</title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px;color:#111}
          h2{margin:0 0 12px 0}
          table{width:100%;border-collapse:collapse;margin-top:10px}
          th,td{border:1px solid #ccc;padding:8px;text-align:right}
          tfoot th{background:#f7f7f7}
        </style>
      </head>
      <body>
        <h2>ÙØ§ØªÙˆØ±Ø©</h2>
        <div>ØªØ§Ø±ÙŠØ®: ${o.date||''}</div>
        <hr/>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø®ØµÙ…</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr><th colspan="4" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±Ø¹ÙŠ</th><th>${fmt(sub)} AED</th></tr>
            <tr><th colspan="4" style="text-align:left">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</th><th>${fmt(del)} AED</th></tr>
            <tr><th colspan="4" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</th><th>${fmt(total)} AED</th></tr>
          </tfoot>
        </table>
        <div style="margin-top:16px">
          <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
        </div>
      </body>
      </html>
    `);
    win.document.close();
  }

  // ====== Reports ======
  function currency(n){ return (Number(n)||0).toFixed(2) + ' AED'; }
  function renderReports(){
    const stats = calcStats();
    const invValue = sum(stats.map(s=>s.stock * s.avgCost));
    const revenue = sum(stats.map(s=>s.revenue));
    const deliverySum = (db.sales||[]).reduce((a,b)=> a + (Number(b.deliveryFee||0)), 0);
    const cogs = sum(stats.map(s=>s.cogs));
    const profit = (revenue + deliverySum) - cogs;

    const kpis = document.getElementById('kpis'); if(kpis){
      kpis.innerHTML = '';
      const items = [
        {label:'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', value: currency(invValue)},
        {label:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', value: currency(revenue)},
        {label:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„', value: currency(deliverySum)},
        {label:'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)', value: currency(profit)},
      ];
      for(const it of items){
        const d = document.createElement('div'); d.className='kpi';
        d.innerHTML = `<div class="hint">${it.label}</div><div style="font-size:22px;margin-top:6px">${it.value}</div>`;
        kpis.appendChild(d);
      }
    }

    const lowT = document.querySelector('#lowStockTable tbody'); if(lowT){
      lowT.innerHTML='';
      const threshold = Number(db.settings.lowStockThreshold)||0;
      for(const s of stats){
        const tr = document.createElement('tr');
        let tag = '<span class="tag ok">Ø¬ÙŠØ¯</span>';
        if(s.stock <= threshold) tag = '<span class="tag danger">Ù…Ù†Ø®ÙØ¶</span>';
        else if(s.stock <= threshold*1.5) tag = '<span class="tag warn">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶</span>';
        tr.innerHTML = `<td>${s.name}</td><td>${s.stock}</td><td>${tag}</td>`;
        lowT.appendChild(tr);
      }
    }

    const topT = document.querySelector('#topProductsTable tbody'); if(topT){
      topT.innerHTML='';
      const top = [...stats].sort((a,b)=>b.revenue - a.revenue).slice(0,10);
      for(const s of top){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.name}</td><td>${s.soldQty||0}</td><td>${currency(s.revenue)}</td>`;
        topT.appendChild(tr);
      }
    }
  }

  // ====== Dashboard ======
  function renderDashboard() {
    if (typeof window.dashboardModule === 'undefined') return;
    
    // Initialize dashboard state
    let currentPeriod = 'today';
    let customStartDate = '';
    let customEndDate = '';
    
    // Period selection handling
    const periodButtons = document.querySelectorAll('[data-period]');
    const customDateRange = document.getElementById('customDateRange');
    const customStart = document.getElementById('customStartDate');
    const customEnd = document.getElementById('customEndDate');
    
    function updatePeriodSelection(period) {
      currentPeriod = period;
      periodButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      customDateRange.hidden = period !== 'custom';
      updateDashboard();
    }
    
    function updateDashboard() {
      customStartDate = customStart?.value || '';
      customEndDate = customEnd?.value || '';
      
      // Update KPIs
      const kpis = window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate);
      renderKPIs(kpis);
      
      // Update chart
      updateChart(kpis.dailyData);
      
      // Update summary table
      const summary = window.dashboardModule.generateDailySummary(currentPeriod, customStartDate, customEndDate);
      renderSummaryTable(summary);
    }
    
    function renderKPIs(kpis) {
      const kpiContainer = document.getElementById('dashboardKpis');
      if (!kpiContainer) return;
      
      kpiContainer.innerHTML = '';
      const items = [
        {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', value: currency(kpis.totalSales)},
        {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', value: currency(kpis.totalPurchases)},
        {label:'Ø§Ù„Ø±Ø¨Ø­', value: currency(kpis.profit)},
        {label:'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', value: currency(kpis.stock)},
      ];
      
      for(const item of items) {
        const d = document.createElement('div');
        d.className = 'kpi';
        d.innerHTML = `<div class="hint">${item.label}</div><div style="font-size:22px;margin-top:6px">${item.value}</div>`;
        kpiContainer.appendChild(d);
      }
    }
    
    function updateChart(dailyData) {
      const dataset = document.getElementById('chartDataset')?.value || 'sales';
      const chartType = document.getElementById('chartType')?.value || 'line';
      window.dashboardModule.renderChart('dashboardChart', dailyData, chartType, dataset);
    }
    
    function renderSummaryTable(summary) {
      const tbody = document.querySelector('#dashboardSummaryTable tbody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      for(const day of summary) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${day.date}</td>
          <td>${currency(day.sales)}</td>
          <td>${currency(day.purchases)}</td>
          <td>${currency(day.profit)}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    
    // Event listeners
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => updatePeriodSelection(btn.dataset.period));
    });
    
    if (customStart) customStart.addEventListener('change', updateDashboard);
    if (customEnd) customEnd.addEventListener('change', updateDashboard);
    
    const chartDataset = document.getElementById('chartDataset');
    const chartType = document.getElementById('chartType');
    if (chartDataset) chartDataset.addEventListener('change', () => updateChart(window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate).dailyData));
    if (chartType) chartType.addEventListener('change', () => updateChart(window.dashboardModule.calculateKPIs(currentPeriod, customStartDate, customEndDate).dailyData));
    
    // Initialize with today's data
    updatePeriodSelection('today');
  }

  // ====== Settings ======
  const lowStockThreshold = document.getElementById('lowStockThreshold');
  function renderSettings(){ if(lowStockThreshold) lowStockThreshold.value = db.settings.lowStockThreshold; }
  document.getElementById('saveSettings').onclick = ()=>{ db.settings.lowStockThreshold = Number(lowStockThreshold.value)||0; try{ recordAudit('edit','settings','', 'lowStockThreshold='+db.settings.lowStockThreshold);}catch{} saveDB(db); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); refreshAll(); };

  // ====== Backup / Restore / Reset ======
  document.getElementById('btnBackup').onclick = ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mini-store-backup.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
  };
  document.getElementById('btnRestore').onclick = ()=> document.getElementById('restoreFile').click();
  document.getElementById('restoreFile').onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = ()=>{ try{ db = JSON.parse(reader.result); saveDB(db); refreshAll(); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­'); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } }; reader.readAsText(file);
    e.target.value='';
  };
  const btnResetEl = document.getElementById('btnReset');
  btnResetEl.onclick = ()=>{
    if(!softConfirm(btnResetEl,'ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø©ØŸ')) return;
    db = deepClone(defaults); saveDB(db); refreshAll(); alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·');
  };

  // ====== Soft Confirm ======
  function softConfirm(btn, labelConfirm='ØªØ£ÙƒÙŠØ¯ØŸ'){
    if(!btn.dataset.arm){
      btn.dataset.arm = '1';
      const old = btn.textContent; btn.dataset.oldText = old;
      btn.textContent = labelConfirm;
      setTimeout(()=>{ btn.dataset.arm=''; btn.textContent = btn.dataset.oldText||old; }, 2000);
      return false;
    }
    btn.dataset.arm='';
    btn.textContent = btn.dataset.oldText||btn.textContent;
    return true;
  }
  //========New=======
  // ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù…ÙˆØ­Ù‘Ø¯ + ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
async function confirmDeleteUniversal(module, id, name = '', extraQty = '') {
  // ØµÙ„Ø§Ø­ÙŠØ§Øª
  if (typeof can === 'function' && !can(module, 'delete')) {
    alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­Ø°Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©');
    return { ok: false };
  }

  const title = `Ø­Ø°Ù ${name ? 'Â«' + name + 'Â»' : 'Ø§Ù„Ø¹Ù†ØµØ±'} Ù…Ù† ${module}?`;
  if (!confirm(title)) return { ok: false };

  // Ø³Ø¨Ø¨ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
  const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';

  try {
    if (typeof recordAudit === 'function') {
      const details = name ? `${name}${reason ? ' â€” ' + reason : ''}` : reason;
      recordAudit('delete', module, id || '', details, extraQty);
    }
  } catch (_) {}

  return { ok: true, reason };
}
  // ====== Export CSV ======
  function exportTableToCSV(tableId, filename, mode='window'){
    const table = document.getElementById(tableId);
    if(!table){ alert('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

    const headRow = table.tHead && table.tHead.rows[0] ? table.tHead.rows[0] : null;
    const totalCols = headRow ? headRow.cells.length : (table.rows[0] ? table.rows[0].cells.length : 0);
    const includeIdx = Array.from({length: totalCols}, (_,i)=>i).filter(i=>{
      const th = headRow ? headRow.cells[i] : null;
      if(!th) return true;
      const text = (th.textContent||'').replace(/\s+/g,' ').trim();
      const interactive = th.querySelector && th.querySelector('button,input,select');
      return text !== '' && !interactive;
    });

    const allRows = Array.from(table.querySelectorAll('thead tr, tbody tr, tfoot tr'));
    const csv = allRows.map(row => {
      const cells = Array.from(row.children);
      const parts = includeIdx.map(i=>{
        const cell = cells[i]; if(!cell) return '';
        if(cell.querySelector && cell.querySelector('button,input,select')) return '';
        let text = (cell.textContent||'').replace(/\s+/g,' ').trim();
        if (text.includes('"') || text.includes(',')) text = '"' + text.replace(/"/g,'""') + '"';
        return text;
      });
      return parts.join(',');
    }).join('\n');

    const csvWithBom = "\uFEFF" + csv;
    const safeName = (filename && filename.endsWith('.csv')) ? filename : (filename || 'export') + '.csv';

    if (mode === 'window'){
      const url = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvWithBom);
      const w = window.open(url, '_blank');
      if(!w || w.closed){
        try{
          const blob = new Blob([csvWithBom], {type:'text/csv;charset=utf-8;'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = safeName;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          setTimeout(()=> URL.revokeObjectURL(a.href), 500);
        }catch(err){ console.error('CSV open/download failed', err); alert('ØªØ¹Ø°Ø± ÙØªØ­/ØªÙ†Ø²ÙŠÙ„ CSV: '+err.message); }
      }
      return;
    }

    try{
      const blob = new Blob([csvWithBom], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = safeName;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(()=> URL.revokeObjectURL(a.href), 500);
    }catch(err){ console.error('CSV download failed', err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: '+err.message); }
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-export][data-table]');
    if(!btn) return;
    try{ exportTableToCSV(btn.dataset.table, btn.dataset.filename || 'export.csv', 'window'); }
    catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØµØ¯ÙŠØ±: '+ err.message); }
  });

  // ====== Refresh All ======
  function refreshAll(){
    renderProducts(); renderPurchases(); renderSales(); renderReports(); renderSettings();
    try { if (typeof renderAudit === 'function') renderAudit(); } catch (e) { console.warn('renderAudit error', e); }
    try { if (typeof renderUsersAdmin === 'function') renderUsersAdmin(); } catch (e) { console.warn('renderUsersAdmin error', e); }
    try { if (typeof renderDashboard === 'function') renderDashboard(); } catch (e) { console.warn('renderDashboard error', e); }
  }

  // ====== Auth UI ======
  const authOverlay = document.getElementById('authOverlay');
  const authBody = document.getElementById('authBody');
  const authTitle = document.getElementById('authTitle');
  const appRoot = document.getElementById('appRoot');
  const whoami = document.getElementById('whoami');
  const btnLogout = document.getElementById('btnLogout');
  btnLogout.onclick = ()=>{ clearSession(); location.reload(); };

  function showAuth(){
    authOverlay.classList.remove('is-hidden');
    authOverlay.hidden = false;
    authOverlay.style.display = 'flex';
    authOverlay.setAttribute('aria-hidden','false');
    appRoot.hidden = true;
  }
  function hideAuth(){
    authOverlay.classList.add('is-hidden');
    authOverlay.hidden = true;
    authOverlay.style.display = 'none';
    authOverlay.setAttribute('aria-hidden','true');
    appRoot.hidden = false;
  }

  function renderLogin(){
    authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    authBody.innerHTML = `
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="loginUser" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="loginPass" type="password" />
      <div class="flex" style="margin-top:10px">
        <button id="doLogin" class="btn-primary" type="button">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div class="hint">Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø¨Ø¹Ø¯ØŒ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    `;
    document.getElementById('doLogin').onclick = doLogin;
  }

  function renderCreate(){
    authTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠØ±';
    authBody.innerHTML = `
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="regUser" placeholder="Ù…Ø«Ø§Ù„: admin" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="regPass" type="password" />
      <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="regPass2" type="password" />
      <div class="flex" style="margin-top:10px">
        <button id="doCreate" class="btn-primary" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
      </div>
      <div class="hint">ØªÙØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ´ÙÙ‘Ø±Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.</div>
    `;
    document.getElementById('doCreate').onclick = doCreate;
  }

  async function doCreate(){
    const u = document.getElementById('regUser').value.trim();
    const p1 = document.getElementById('regPass').value;
    const p2 = document.getElementById('regPass2').value;
    if(!u || !p1) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±');
    if(p1 !== p2) return alert('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚');
    const users = loadUsers();
    if(users.find(x=>x.username.toLowerCase()===u.toLowerCase())) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§');
    const salt = genSalt();
    const hash = await sha256(p1 + salt);
    users.push({ username:u, salt, hash });
    saveUsers(users);
    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.');
    renderLogin();
  }

  async function doLogin(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    const users = loadUsers();
    const rec = users.find(x=>x.username.toLowerCase()===u.toLowerCase());
    if(!rec) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    const hash = await sha256(p + rec.salt);
    if(hash !== rec.hash) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    setSession(rec.username);
    startApp(rec.username);
  }

  async function startApp(username){
    currentUser = username;
    dbKey = dbKeyBase; try { const legacy = localStorage.getItem(dbKeyBase + ':' + username); if(legacy && !localStorage.getItem(dbKey)) localStorage.setItem(dbKey, legacy); } catch(e){}
    db = loadDB();
    App.setDB(db);
    whoami.textContent = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + username;
    btnLogout.hidden = false;
    hideAuth();
    activateTab(getLastTab());
  }

  // ====== Change password ======
  document.getElementById('btnChangePass').onclick = async ()=>{
    const cur = document.getElementById('curPass').value;
    const n1 = document.getElementById('newPass').value;
    const n2 = document.getElementById('newPass2').value;
    if(!n1 || n1 !== n2) return alert('ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯');
    const users = loadUsers();
    const rec = users.find(x=>x.username===currentUser);
    if(!rec) return alert('Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const hcur = await sha256(cur + rec.salt);
    if(hcur !== rec.hash) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    rec.salt = genSalt();
    rec.hash = await sha256(n1 + rec.salt);
    saveUsers(users);
    alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    document.getElementById('curPass').value = document.getElementById('newPass').value = document.getElementById('newPass2').value = '';
  };

  // ====== Boot ======
  (async function boot(){
    const session = getSession();
    const users = loadUsers();
    showAuth();
    if(!users.length){
      renderCreate();
    }else if(session && session.username){
      await startApp(session.username);
    }else{
      renderLogin();
    }
  })();
  </script>

  <!-- LILIJA modules -->
  <script src="modules/utils.js"></script>
  <script src="modules/auth.js"></script>
  <script src="modules/data.js"></script>
  <script src="modules/users_admin.js"></script>
  <script src="modules/audit_log.js"></script>
  <script src="modules/dashboard.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const b = document.getElementById('bootChecks');
      if (b) b.textContent = 'ÙˆØ­Ø¯Ø§Øª Ù…Ø­Ù…Ù‘Ù„Ø©: Ø³Ø¬Ù„/Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†';
      if (document.querySelector('.tab.active')?.dataset.tab === 'audit' && typeof renderAudit === 'function') {
        renderAudit();
      }
    });
  </script>

</body>
</html>
